(()=>{var e={};e.id=43,e.ids=[43],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:e=>{"use strict";e.exports=import("pg")},91911:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{patchFetch:()=>l,routeModule:()=>c,serverHooks:()=>f,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>p});var n=r(42706),i=r(28203),s=r(45994),d=r(39520),o=e([d]);d=(o.then?(await o)():o)[0];let c=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/feedback/route",pathname:"/api/feedback",filename:"route",bundlePath:"app/api/feedback/route"},resolvedPagePath:"/Users/berriesdesign/Documents/repos/illustration-agent/src/app/api/feedback/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:u,workUnitAsyncStorage:p,serverHooks:f}=c;function l(){return(0,s.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:p})}a()}catch(e){a(e)}})},96487:()=>{},78335:()=>{},39520:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>u});var n=r(39187),i=r(65658),s=r(98785),d=r(62693),o=r(48590),l=r(47579),c=e([s,d]);[s,d]=c.then?(await c)():c;let p=i.gM("type",[i.Ik({type:i.eu("accepted"),notes:i.Yj().optional()}),i.Ik({type:i.eu("edit-requested"),editDescription:i.Yj().min(1),preserveAspects:i.YO(i.Yj()).default([])}),i.Ik({type:i.eu("rejected"),reason:i.Yj().optional()})]),f=i.Ik({generationId:i.Yj().uuid(),imageIndex:i.ai().int().min(0).max(2).optional(),feedback:p});async function u(e){let t=await e.json().catch(()=>({})),r=f.safeParse(t);if(!r.success)return n.NextResponse.json({error:"Invalid body",details:r.error.flatten()},{status:400});let{generationId:a,imageIndex:i=0,feedback:c}=r.data,[u]=await d.db.select().from(o.generations).where((0,l.eq)(o.generations.id,a)).limit(1);if(!u)return n.NextResponse.json({error:"Generation not found"},{status:404});let p="accepted"===c.type?"accepted":"edit-requested"===c.type?"edit-requested":"rejected",y=await (0,s.$0)({generationId:a,feedbackType:p,editDescription:"edit-requested"===c.type?c.editDescription:null,preserveAspects:"edit-requested"===c.type?c.preserveAspects:null,rejectionReason:"rejected"===c.type?c.reason??null:null}),m="accepted"===c.type?"accepted":"rejected"===c.type?"rejected":"rated";return await d.db.update(o.generations).set({status:m}).where((0,l.eq)(o.generations.id,a)),n.NextResponse.json({id:y?.id,generationId:a,feedbackType:p,imageIndex:i})}a()}catch(e){a(e)}})},62693:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.d(t,{db:()=>l});var n=r(78915),i=r(64939),s=r(48590),d=e([i,n]);[i,n]=d.then?(await d)():d;let o=null,l=new Proxy({},{get:(e,t)=>(function(){if(o)return o;let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set");let t=new i.default.Pool({connectionString:e});return o=(0,n.fd)(t,{schema:s})})()[t]});a()}catch(e){a(e)}})},98785:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.d(t,{$0:()=>v,DV:()=>m,GA:()=>w,Gx:()=>g,Ny:()=>c,Xl:()=>l,ZG:()=>y,ZK:()=>h,jW:()=>p,mZ:()=>f,wH:()=>b});var n=r(47579),i=r(92489),s=r(62693),d=r(48590),o=e([s]);async function l(e){let[t]=await s.db.select().from(d.styleProfiles).where((0,n.eq)(d.styleProfiles.id,e)).limit(1);return t?u(t):null}async function c(e){return(await s.db.select().from(d.styleProfiles).where((0,n.eq)(d.styleProfiles.userId,e)).orderBy((0,i.i)(d.styleProfiles.updatedAt))).map(u)}function u(e){return{id:e.id,name:e.name,userId:e.userId,references:e.references??[],masterPrompt:e.masterPrompt,styleEmbedding:e.styleEmbedding??null,colorPalette:e.colorPalette??[],keyCharacteristics:e.characteristics??[],generationSettings:e.generationSettings??{},createdAt:e.createdAt,updatedAt:e.updatedAt}}async function p(e){let[t]=await s.db.insert(d.styleProfiles).values({userId:e.userId??null,name:e.name,references:e.references??[],masterPrompt:e.masterPrompt??null,styleEmbedding:e.styleEmbedding,colorPalette:e.colorPalette??[],characteristics:e.characteristics??[],generationSettings:e.generationSettings??{}}).returning();return t?u(t):null}async function f(e,t){let r={updatedAt:new Date};void 0!==t.name&&(r.name=t.name),void 0!==t.masterPrompt&&(r.masterPrompt=t.masterPrompt),void 0!==t.references&&(r.references=t.references),void 0!==t.styleEmbedding&&(r.styleEmbedding=t.styleEmbedding),void 0!==t.colorPalette&&(r.colorPalette=t.colorPalette),void 0!==t.characteristics&&(r.characteristics=t.characteristics),void 0!==t.generationSettings&&(r.generationSettings=t.generationSettings);let[a]=await s.db.update(d.styleProfiles).set(r).where((0,n.eq)(d.styleProfiles.id,e)).returning();return a?u(a):null}async function y(e){let[t]=await s.db.select().from(d.generations).where((0,n.eq)(d.generations.id,e)).limit(1);return t??null}async function m(e){let t=await y(e);if(!t)return null;let r=await s.db.select().from(d.generations).where((0,n.eq)(d.generations.parentId,e)),a=await Promise.all(r.map(e=>m(e.id)));return{...t,children:a.filter(e=>null!==e)}}async function g(e){let t=await s.db.insert(d.generations).values({projectId:e.projectId??null,parentId:e.parentId??null,styleProfileId:e.styleProfileId,prompt:e.prompt,imageUrl:e.imageUrl??null,provider:e.provider??null,status:e.status??"pending",metadata:e.metadata??{}}).returning();return Array.isArray(t)?t[0]:null}async function v(e){let[t]=await s.db.insert(d.feedback).values(e).returning();return t}async function w(e){let[t]=await s.db.select().from(d.canvasState).where((0,n.eq)(d.canvasState.projectId,e)).limit(1);return t??null}async function h(e,t){await s.db.insert(d.canvasState).values({projectId:e,state:t}).onConflictDoUpdate({target:d.canvasState.projectId,set:{state:t,updatedAt:new Date}})}async function b(e,t){let r=(await s.db.select({id:d.generations.id}).from(d.generations).where((0,n.eq)(d.generations.styleProfileId,e)).orderBy((0,i.i)(d.generations.createdAt)).limit(100)).map(e=>e.id);return 0===r.length?[]:s.db.select().from(d.feedback).where((0,n.RV)(d.feedback.generationId,r)).orderBy((0,i.i)(d.feedback.createdAt)).limit(t)}s=(o.then?(await o)():o)[0],a()}catch(e){a(e)}})},48590:(e,t,r)=>{"use strict";r.r(t),r.d(t,{canvasState:()=>g,feedback:()=>y,generations:()=>f,providerPerformance:()=>m,styleProfiles:()=>p,users:()=>u});var a=r(78585),n=r(60011),i=r(99063),s=r(32590),d=r(44799),o=r(57102),l=r(9848),c=r(43796);let u=(0,a.cJ)("users",{id:(0,n.uR)("id").primaryKey().defaultRandom(),email:(0,i.yf)("email",{length:255}).notNull().unique(),createdAt:(0,s.vE)("created_at").defaultNow().notNull(),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()}),p=(0,a.cJ)("style_profiles",{id:(0,n.uR)("id").primaryKey().defaultRandom(),userId:(0,n.uR)("user_id").references(()=>u.id),name:(0,i.yf)("name",{length:255}).notNull(),masterPrompt:(0,d.Qq)("master_prompt"),styleEmbedding:(0,o.Fx)("style_embedding").$type(),colorPalette:(0,o.Fx)("color_palette").$type().default([]),characteristics:(0,o.Fx)("characteristics").$type().default([]),generationSettings:(0,o.Fx)("generation_settings").$type().default({}),references:(0,o.Fx)("references").$type().default([]),createdAt:(0,s.vE)("created_at").defaultNow().notNull(),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()}),f=(0,a.cJ)("generations",{id:(0,n.uR)("id").primaryKey().defaultRandom(),projectId:(0,n.uR)("project_id"),parentId:(0,n.uR)("parent_id"),styleProfileId:(0,n.uR)("style_profile_id").references(()=>p.id).notNull(),prompt:(0,d.Qq)("prompt").notNull(),imageUrl:(0,i.yf)("image_url",{length:512}),provider:(0,i.yf)("provider",{length:50}),status:(0,i.yf)("status",{length:20}).notNull().default("pending"),metadata:(0,o.Fx)("metadata").$type().default({}),createdAt:(0,s.vE)("created_at").defaultNow().notNull()}),y=(0,a.cJ)("feedback",{id:(0,n.uR)("id").primaryKey().defaultRandom(),generationId:(0,n.uR)("generation_id").references(()=>f.id).notNull(),feedbackType:(0,i.yf)("feedback_type",{length:20}).notNull(),editDescription:(0,d.Qq)("edit_description"),preserveAspects:(0,o.Fx)("preserve_aspects").$type(),rejectionReason:(0,d.Qq)("rejection_reason"),refinedPrompt:(0,d.Qq)("refined_prompt"),createdAt:(0,s.vE)("created_at").defaultNow().notNull()}),m=(0,a.cJ)("provider_performance",{id:(0,n.uR)("id").primaryKey().defaultRandom(),styleProfileId:(0,n.uR)("style_profile_id").references(()=>p.id),providerName:(0,i.yf)("provider_name",{length:50}).notNull(),taskType:(0,i.yf)("task_type",{length:50}).notNull(),successCount:(0,l.nd)("success_count").notNull().default(0),failureCount:(0,l.nd)("failure_count").notNull().default(0),avgQualityScore:(0,c.x)("avg_quality_score"),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()}),g=(0,a.cJ)("canvas_state",{projectId:(0,n.uR)("project_id").primaryKey(),state:(0,o.Fx)("state").$type().notNull(),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,452,915,658],()=>r(91911));module.exports=a})();