(()=>{var e={};e.id=608,e.ids=[608],e.modules={91043:e=>{"use strict";e.exports=require("@aws-sdk/client-s3")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},29021:e=>{"use strict";e.exports=require("fs")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},33873:e=>{"use strict";e.exports=require("path")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},64939:e=>{"use strict";e.exports=import("pg")},73024:e=>{"use strict";e.exports=require("node:fs")},57075:e=>{"use strict";e.exports=require("node:stream")},37830:e=>{"use strict";e.exports=require("node:stream/web")},77869:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{patchFetch:()=>c,routeModule:()=>u,serverHooks:()=>f,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>p});var a=r(42706),n=r(28203),i=r(45994),o=r(41137),l=e([o]);o=(l.then?(await l)():l)[0];let u=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/styles/route",pathname:"/api/styles",filename:"route",bundlePath:"app/api/styles/route"},resolvedPagePath:"/Users/berriesdesign/Documents/repos/illustration-agent/src/app/api/styles/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:d,workUnitAsyncStorage:p,serverHooks:f}=u;function c(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:p})}s()}catch(e){s(e)}})},96487:()=>{},78335:()=>{},52170:(e,t,r)=>{"use strict";function s(e){return e.headers.get("x-user-id")??null}r.d(t,{F:()=>s}),r(39187)},41137:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>d,POST:()=>p});var a=r(39187),n=r(52170),i=r(98785),o=r(70248),l=r(41522),c=r(39391),u=e([i]);async function d(e){let t=(0,n.F)(e);if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let r=await (0,i.Ny)(t);return a.NextResponse.json(r)}async function p(e){let t=(0,n.F)(e),s=await e.formData(),u=s.get("name");if(!u?.trim())return a.NextResponse.json({error:"name is required"},{status:400});let d=[],p=s.getAll("files");if(p.length>0){let{uploadBuffer:e}=await r.e(988).then(r.bind(r,57988));for(let r=0;r<p.length;r++){let s=p[r];if(!s.type.startsWith("image/"))continue;let a=Buffer.from(await s.arrayBuffer()),n=`styles/${t??"anon"}/${Date.now()}-${r}-${s.name}`,i=await e(n,a,s.type);d.push({url:i})}}let f=s.get("referenceUrls");if(f&&"string"==typeof f)try{JSON.parse(f).forEach(e=>d.push({url:e}))}catch{}if(0===d.length)return a.NextResponse.json({error:"At least one reference image (file or URL) is required"},{status:400});let y=await (0,o.Z)(d),m=Array.from(new Set(y.flatMap(e=>e.analysis?.colors??[]))).slice(0,15),g=Array.from(new Set(y.flatMap(e=>e.analysis?.styleDescriptors??[]))).slice(0,20),h=(0,l.p)(y,m,g),w=await (0,c.I)(h,g),v=await (0,i.jW)({userId:t??void 0,name:u.trim(),references:y,masterPrompt:h,styleEmbedding:w,colorPalette:m,characteristics:g,generationSettings:{}});return v?a.NextResponse.json(v):a.NextResponse.json({error:"Failed to create style profile"},{status:500})}i=(u.then?(await u)():u)[0],s()}catch(e){s(e)}})},62693:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{db:()=>c});var a=r(78915),n=r(64939),i=r(48590),o=e([n,a]);[n,a]=o.then?(await o)():o;let l=null,c=new Proxy({},{get:(e,t)=>(function(){if(l)return l;let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set");let t=new n.default.Pool({connectionString:e});return l=(0,a.fd)(t,{schema:i})})()[t]});s()}catch(e){s(e)}})},98785:(e,t,r)=>{"use strict";r.a(e,async(e,s)=>{try{r.d(t,{$0:()=>h,DV:()=>m,GA:()=>w,Gx:()=>g,Ny:()=>u,Xl:()=>c,ZG:()=>y,ZK:()=>v,jW:()=>p,mZ:()=>f,wH:()=>x});var a=r(47579),n=r(92489),i=r(62693),o=r(48590),l=e([i]);async function c(e){let[t]=await i.db.select().from(o.styleProfiles).where((0,a.eq)(o.styleProfiles.id,e)).limit(1);return t?d(t):null}async function u(e){return(await i.db.select().from(o.styleProfiles).where((0,a.eq)(o.styleProfiles.userId,e)).orderBy((0,n.i)(o.styleProfiles.updatedAt))).map(d)}function d(e){return{id:e.id,name:e.name,userId:e.userId,references:e.references??[],masterPrompt:e.masterPrompt,styleEmbedding:e.styleEmbedding??null,colorPalette:e.colorPalette??[],keyCharacteristics:e.characteristics??[],generationSettings:e.generationSettings??{},createdAt:e.createdAt,updatedAt:e.updatedAt}}async function p(e){let[t]=await i.db.insert(o.styleProfiles).values({userId:e.userId??null,name:e.name,references:e.references??[],masterPrompt:e.masterPrompt??null,styleEmbedding:e.styleEmbedding,colorPalette:e.colorPalette??[],characteristics:e.characteristics??[],generationSettings:e.generationSettings??{}}).returning();return t?d(t):null}async function f(e,t){let r={updatedAt:new Date};void 0!==t.name&&(r.name=t.name),void 0!==t.masterPrompt&&(r.masterPrompt=t.masterPrompt),void 0!==t.references&&(r.references=t.references),void 0!==t.styleEmbedding&&(r.styleEmbedding=t.styleEmbedding),void 0!==t.colorPalette&&(r.colorPalette=t.colorPalette),void 0!==t.characteristics&&(r.characteristics=t.characteristics),void 0!==t.generationSettings&&(r.generationSettings=t.generationSettings);let[s]=await i.db.update(o.styleProfiles).set(r).where((0,a.eq)(o.styleProfiles.id,e)).returning();return s?d(s):null}async function y(e){let[t]=await i.db.select().from(o.generations).where((0,a.eq)(o.generations.id,e)).limit(1);return t??null}async function m(e){let t=await y(e);if(!t)return null;let r=await i.db.select().from(o.generations).where((0,a.eq)(o.generations.parentId,e)),s=await Promise.all(r.map(e=>m(e.id)));return{...t,children:s.filter(e=>null!==e)}}async function g(e){let t=await i.db.insert(o.generations).values({projectId:e.projectId??null,parentId:e.parentId??null,styleProfileId:e.styleProfileId,prompt:e.prompt,imageUrl:e.imageUrl??null,provider:e.provider??null,status:e.status??"pending",metadata:e.metadata??{}}).returning();return Array.isArray(t)?t[0]:null}async function h(e){let[t]=await i.db.insert(o.feedback).values(e).returning();return t}async function w(e){let[t]=await i.db.select().from(o.canvasState).where((0,a.eq)(o.canvasState.projectId,e)).limit(1);return t??null}async function v(e,t){await i.db.insert(o.canvasState).values({projectId:e,state:t}).onConflictDoUpdate({target:o.canvasState.projectId,set:{state:t,updatedAt:new Date}})}async function x(e,t){let r=(await i.db.select({id:o.generations.id}).from(o.generations).where((0,a.eq)(o.generations.styleProfileId,e)).orderBy((0,n.i)(o.generations.createdAt)).limit(100)).map(e=>e.id);return 0===r.length?[]:i.db.select().from(o.feedback).where((0,a.RV)(o.feedback.generationId,r)).orderBy((0,n.i)(o.feedback.createdAt)).limit(t)}i=(l.then?(await l)():l)[0],s()}catch(e){s(e)}})},48590:(e,t,r)=>{"use strict";r.r(t),r.d(t,{canvasState:()=>g,feedback:()=>y,generations:()=>f,providerPerformance:()=>m,styleProfiles:()=>p,users:()=>d});var s=r(78585),a=r(60011),n=r(99063),i=r(32590),o=r(44799),l=r(57102),c=r(9848),u=r(43796);let d=(0,s.cJ)("users",{id:(0,a.uR)("id").primaryKey().defaultRandom(),email:(0,n.yf)("email",{length:255}).notNull().unique(),createdAt:(0,i.vE)("created_at").defaultNow().notNull(),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()}),p=(0,s.cJ)("style_profiles",{id:(0,a.uR)("id").primaryKey().defaultRandom(),userId:(0,a.uR)("user_id").references(()=>d.id),name:(0,n.yf)("name",{length:255}).notNull(),masterPrompt:(0,o.Qq)("master_prompt"),styleEmbedding:(0,l.Fx)("style_embedding").$type(),colorPalette:(0,l.Fx)("color_palette").$type().default([]),characteristics:(0,l.Fx)("characteristics").$type().default([]),generationSettings:(0,l.Fx)("generation_settings").$type().default({}),references:(0,l.Fx)("references").$type().default([]),createdAt:(0,i.vE)("created_at").defaultNow().notNull(),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()}),f=(0,s.cJ)("generations",{id:(0,a.uR)("id").primaryKey().defaultRandom(),projectId:(0,a.uR)("project_id"),parentId:(0,a.uR)("parent_id"),styleProfileId:(0,a.uR)("style_profile_id").references(()=>p.id).notNull(),prompt:(0,o.Qq)("prompt").notNull(),imageUrl:(0,n.yf)("image_url",{length:512}),provider:(0,n.yf)("provider",{length:50}),status:(0,n.yf)("status",{length:20}).notNull().default("pending"),metadata:(0,l.Fx)("metadata").$type().default({}),createdAt:(0,i.vE)("created_at").defaultNow().notNull()}),y=(0,s.cJ)("feedback",{id:(0,a.uR)("id").primaryKey().defaultRandom(),generationId:(0,a.uR)("generation_id").references(()=>f.id).notNull(),feedbackType:(0,n.yf)("feedback_type",{length:20}).notNull(),editDescription:(0,o.Qq)("edit_description"),preserveAspects:(0,l.Fx)("preserve_aspects").$type(),rejectionReason:(0,o.Qq)("rejection_reason"),refinedPrompt:(0,o.Qq)("refined_prompt"),createdAt:(0,i.vE)("created_at").defaultNow().notNull()}),m=(0,s.cJ)("provider_performance",{id:(0,a.uR)("id").primaryKey().defaultRandom(),styleProfileId:(0,a.uR)("style_profile_id").references(()=>p.id),providerName:(0,n.yf)("provider_name",{length:50}).notNull(),taskType:(0,n.yf)("task_type",{length:50}).notNull(),successCount:(0,c.nd)("success_count").notNull().default(0),failureCount:(0,c.nd)("failure_count").notNull().default(0),avgQualityScore:(0,u.x)("avg_quality_score"),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()}),g=(0,s.cJ)("canvas_state",{projectId:(0,a.uR)("project_id").primaryKey(),state:(0,l.Fx)("state").$type().notNull(),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()})},39391:(e,t,r)=>{"use strict";r.d(t,{I:()=>n});var s=r(47590);async function a(e){let t=await new s.Ay({apiKey:process.env.OPENAI_API_KEY}).embeddings.create({model:"text-embedding-3-small",input:e.slice(0,8e3)}),r=t.data[0]?.embedding;if(!r||1536!==r.length)throw Error("Invalid embedding response");return r}async function n(e,t){return a([e,...t].filter(Boolean).join(" ")||"illustration style")}},41522:(e,t,r)=>{"use strict";function s(e,t,r){let s=[],a=new Set,n=new Set,i=new Set(t);for(let t of e){let e=t.analysis;e&&(e.styleDescriptors.forEach(e=>a.add(e)),e.technicalAttributes.forEach(e=>n.add(e)),e.colors.forEach(e=>i.add(e)))}for(let t of(r.forEach(e=>a.add(e)),i.size>0&&s.push(`Color palette: ${Array.from(i).slice(0,12).join(", ")}.`),a.size>0&&s.push(`Style: ${Array.from(a).slice(0,15).join(", ")}.`),n.size>0&&s.push(`Technical: ${Array.from(n).slice(0,10).join(", ")}.`),e))if(t.analysis?.composition){s.push(`Composition note: ${t.analysis.composition}.`);break}return s.join(" ").trim()||"Consistent illustration style."}function a(e,t,r=[]){return{prompt:`${e} ${t}`.trim(),negativePrompt:r.length>0?r.join(", "):"blurry, low quality, inconsistent style, text, watermark"}}r.d(t,{T:()=>a,p:()=>s})},70248:(e,t,r)=>{"use strict";r.d(t,{Z:()=>i});var s=r(47590);let a=`You are an expert at analyzing illustration and art style. For each reference image, extract:
1. colorPalette: array of 5-10 hex or descriptive colors (e.g. "#2d5016", "warm ochre")
2. composition: brief description (layout, balance, focal points)
3. styleDescriptors: 5-15 terms (e.g. "flat design", "line art", "gouache", "minimal")
4. technicalAttributes: line weight, texture, rendering style, medium hints

Respond with valid JSON only, no markdown.`;async function n(e){let t=await new s.Ay({apiKey:process.env.OPENAI_API_KEY}).chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:a},{role:"user",content:[{type:"text",text:"Analyze this reference image and return the JSON object with colorPalette, composition, styleDescriptors, technicalAttributes."},{type:"image_url",image_url:{url:e}}]}],max_tokens:1024}),r=t.choices[0]?.message?.content?.trim();if(!r)throw Error("Empty analysis response");let n=JSON.parse(r);return{colors:Array.isArray(n.colors)?n.colors:n.colorPalette??[],composition:n.composition??"",styleDescriptors:Array.isArray(n.styleDescriptors)?n.styleDescriptors:[],technicalAttributes:Array.isArray(n.technicalAttributes)?n.technicalAttributes:[]}}async function i(e){let t=[];for(let r of e){if(r.analysis){t.push(r);continue}let e=await n(r.url);t.push({...r,analysis:e})}return t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,452,915,590],()=>r(77869));module.exports=s})();