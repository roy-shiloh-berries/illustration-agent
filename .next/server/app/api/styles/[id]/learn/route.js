(()=>{var e={};e.id=253,e.ids=[253],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},29021:e=>{"use strict";e.exports=require("fs")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},33873:e=>{"use strict";e.exports=require("path")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},64939:e=>{"use strict";e.exports=import("pg")},73024:e=>{"use strict";e.exports=require("node:fs")},57075:e=>{"use strict";e.exports=require("node:stream")},37830:e=>{"use strict";e.exports=require("node:stream/web")},18307:(e,t,r)=>{"use strict";r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{patchFetch:()=>d,routeModule:()=>u,serverHooks:()=>m,workAsyncStorage:()=>c,workUnitAsyncStorage:()=>p});var a=r(42706),s=r(28203),i=r(45994),o=r(9922),l=e([o]);o=(l.then?(await l)():l)[0];let u=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/styles/[id]/learn/route",pathname:"/api/styles/[id]/learn",filename:"route",bundlePath:"app/api/styles/[id]/learn/route"},resolvedPagePath:"/Users/berriesdesign/Documents/repos/illustration-agent/src/app/api/styles/[id]/learn/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:c,workUnitAsyncStorage:p,serverHooks:m}=u;function d(){return(0,i.patchFetch)({workAsyncStorage:c,workUnitAsyncStorage:p})}n()}catch(e){n(e)}})},96487:()=>{},78335:()=>{},9922:(e,t,r)=>{"use strict";r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{POST:()=>l});var a=r(39187),s=r(98785),i=r(95138),o=e([s,i]);async function l(e,{params:t}){let{id:r}=await t;if(!await (0,s.Xl)(r))return a.NextResponse.json({error:"Style profile not found"},{status:404});await (0,i.y)(r);let n=await (0,s.Xl)(r);return a.NextResponse.json({ok:!0,masterPrompt:n?.masterPrompt,generationSettings:n?.generationSettings})}[s,i]=o.then?(await o)():o,n()}catch(e){n(e)}})},62693:(e,t,r)=>{"use strict";r.a(e,async(e,n)=>{try{r.d(t,{db:()=>d});var a=r(78915),s=r(64939),i=r(48590),o=e([s,a]);[s,a]=o.then?(await o)():o;let l=null,d=new Proxy({},{get:(e,t)=>(function(){if(l)return l;let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set");let t=new s.default.Pool({connectionString:e});return l=(0,a.fd)(t,{schema:i})})()[t]});n()}catch(e){n(e)}})},98785:(e,t,r)=>{"use strict";r.a(e,async(e,n)=>{try{r.d(t,{$0:()=>h,DV:()=>f,GA:()=>v,Gx:()=>y,Ny:()=>u,Xl:()=>d,ZG:()=>g,ZK:()=>w,jW:()=>p,mZ:()=>m,wH:()=>P});var a=r(47579),s=r(92489),i=r(62693),o=r(48590),l=e([i]);async function d(e){let[t]=await i.db.select().from(o.styleProfiles).where((0,a.eq)(o.styleProfiles.id,e)).limit(1);return t?c(t):null}async function u(e){return(await i.db.select().from(o.styleProfiles).where((0,a.eq)(o.styleProfiles.userId,e)).orderBy((0,s.i)(o.styleProfiles.updatedAt))).map(c)}function c(e){return{id:e.id,name:e.name,userId:e.userId,references:e.references??[],masterPrompt:e.masterPrompt,styleEmbedding:e.styleEmbedding??null,colorPalette:e.colorPalette??[],keyCharacteristics:e.characteristics??[],generationSettings:e.generationSettings??{},createdAt:e.createdAt,updatedAt:e.updatedAt}}async function p(e){let[t]=await i.db.insert(o.styleProfiles).values({userId:e.userId??null,name:e.name,references:e.references??[],masterPrompt:e.masterPrompt??null,styleEmbedding:e.styleEmbedding,colorPalette:e.colorPalette??[],characteristics:e.characteristics??[],generationSettings:e.generationSettings??{}}).returning();return t?c(t):null}async function m(e,t){let r={updatedAt:new Date};void 0!==t.name&&(r.name=t.name),void 0!==t.masterPrompt&&(r.masterPrompt=t.masterPrompt),void 0!==t.references&&(r.references=t.references),void 0!==t.styleEmbedding&&(r.styleEmbedding=t.styleEmbedding),void 0!==t.colorPalette&&(r.colorPalette=t.colorPalette),void 0!==t.characteristics&&(r.characteristics=t.characteristics),void 0!==t.generationSettings&&(r.generationSettings=t.generationSettings);let[n]=await i.db.update(o.styleProfiles).set(r).where((0,a.eq)(o.styleProfiles.id,e)).returning();return n?c(n):null}async function g(e){let[t]=await i.db.select().from(o.generations).where((0,a.eq)(o.generations.id,e)).limit(1);return t??null}async function f(e){let t=await g(e);if(!t)return null;let r=await i.db.select().from(o.generations).where((0,a.eq)(o.generations.parentId,e)),n=await Promise.all(r.map(e=>f(e.id)));return{...t,children:n.filter(e=>null!==e)}}async function y(e){let t=await i.db.insert(o.generations).values({projectId:e.projectId??null,parentId:e.parentId??null,styleProfileId:e.styleProfileId,prompt:e.prompt,imageUrl:e.imageUrl??null,provider:e.provider??null,status:e.status??"pending",metadata:e.metadata??{}}).returning();return Array.isArray(t)?t[0]:null}async function h(e){let[t]=await i.db.insert(o.feedback).values(e).returning();return t}async function v(e){let[t]=await i.db.select().from(o.canvasState).where((0,a.eq)(o.canvasState.projectId,e)).limit(1);return t??null}async function w(e,t){await i.db.insert(o.canvasState).values({projectId:e,state:t}).onConflictDoUpdate({target:o.canvasState.projectId,set:{state:t,updatedAt:new Date}})}async function P(e,t){let r=(await i.db.select({id:o.generations.id}).from(o.generations).where((0,a.eq)(o.generations.styleProfileId,e)).orderBy((0,s.i)(o.generations.createdAt)).limit(100)).map(e=>e.id);return 0===r.length?[]:i.db.select().from(o.feedback).where((0,a.RV)(o.feedback.generationId,r)).orderBy((0,s.i)(o.feedback.createdAt)).limit(t)}i=(l.then?(await l)():l)[0],n()}catch(e){n(e)}})},48590:(e,t,r)=>{"use strict";r.r(t),r.d(t,{canvasState:()=>y,feedback:()=>g,generations:()=>m,providerPerformance:()=>f,styleProfiles:()=>p,users:()=>c});var n=r(78585),a=r(60011),s=r(99063),i=r(32590),o=r(44799),l=r(57102),d=r(9848),u=r(43796);let c=(0,n.cJ)("users",{id:(0,a.uR)("id").primaryKey().defaultRandom(),email:(0,s.yf)("email",{length:255}).notNull().unique(),createdAt:(0,i.vE)("created_at").defaultNow().notNull(),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()}),p=(0,n.cJ)("style_profiles",{id:(0,a.uR)("id").primaryKey().defaultRandom(),userId:(0,a.uR)("user_id").references(()=>c.id),name:(0,s.yf)("name",{length:255}).notNull(),masterPrompt:(0,o.Qq)("master_prompt"),styleEmbedding:(0,l.Fx)("style_embedding").$type(),colorPalette:(0,l.Fx)("color_palette").$type().default([]),characteristics:(0,l.Fx)("characteristics").$type().default([]),generationSettings:(0,l.Fx)("generation_settings").$type().default({}),references:(0,l.Fx)("references").$type().default([]),createdAt:(0,i.vE)("created_at").defaultNow().notNull(),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()}),m=(0,n.cJ)("generations",{id:(0,a.uR)("id").primaryKey().defaultRandom(),projectId:(0,a.uR)("project_id"),parentId:(0,a.uR)("parent_id"),styleProfileId:(0,a.uR)("style_profile_id").references(()=>p.id).notNull(),prompt:(0,o.Qq)("prompt").notNull(),imageUrl:(0,s.yf)("image_url",{length:512}),provider:(0,s.yf)("provider",{length:50}),status:(0,s.yf)("status",{length:20}).notNull().default("pending"),metadata:(0,l.Fx)("metadata").$type().default({}),createdAt:(0,i.vE)("created_at").defaultNow().notNull()}),g=(0,n.cJ)("feedback",{id:(0,a.uR)("id").primaryKey().defaultRandom(),generationId:(0,a.uR)("generation_id").references(()=>m.id).notNull(),feedbackType:(0,s.yf)("feedback_type",{length:20}).notNull(),editDescription:(0,o.Qq)("edit_description"),preserveAspects:(0,l.Fx)("preserve_aspects").$type(),rejectionReason:(0,o.Qq)("rejection_reason"),refinedPrompt:(0,o.Qq)("refined_prompt"),createdAt:(0,i.vE)("created_at").defaultNow().notNull()}),f=(0,n.cJ)("provider_performance",{id:(0,a.uR)("id").primaryKey().defaultRandom(),styleProfileId:(0,a.uR)("style_profile_id").references(()=>p.id),providerName:(0,s.yf)("provider_name",{length:50}).notNull(),taskType:(0,s.yf)("task_type",{length:50}).notNull(),successCount:(0,d.nd)("success_count").notNull().default(0),failureCount:(0,d.nd)("failure_count").notNull().default(0),avgQualityScore:(0,u.x)("avg_quality_score"),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()}),y=(0,n.cJ)("canvas_state",{projectId:(0,a.uR)("project_id").primaryKey(),state:(0,l.Fx)("state").$type().notNull(),updatedAt:(0,i.vE)("updated_at").defaultNow().notNull()})},47229:(e,t,r)=>{"use strict";r.d(t,{L:()=>a});var n=r(47590);async function a(e,t,r){let a=`You analyze feedback on AI-generated illustrations. Given accepted and rejected examples, suggest:
1. recommendations: 3-5 short bullet points on what to change in the master prompt or generation settings.
2. suggestedSettings: optional temperature (0-1) and negativePrompts (array of strings).
Respond with valid JSON only: { "recommendations": string[], "suggestedSettings": { "temperature"?: number, "negativePrompts"?: string[] } }`,s=e.slice(0,10).map(e=>({type:e.feedbackType,prompt:e.originalPrompt??"(none)"})),i=t.slice(0,10).map(e=>({type:e.feedbackType,reason:e.rejectionReason??"(none)",prompt:e.originalPrompt??"(none)"})),o=`Current master prompt: ${r}

Accepted (${e.length} total, sample): ${JSON.stringify(s)}
Rejected (${t.length} total, sample): ${JSON.stringify(i)}

Return JSON with recommendations and suggestedSettings.`,l=await new n.Ay({apiKey:process.env.OPENAI_API_KEY}).chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:o}],max_tokens:1024}),d=l.choices[0]?.message?.content?.trim();if(!d)return{recommendations:[],suggestedSettings:{}};try{let e=JSON.parse(d);return{recommendations:Array.isArray(e.recommendations)?e.recommendations:[],suggestedSettings:e.suggestedSettings??{}}}catch{return{recommendations:[],suggestedSettings:{}}}}},95138:(e,t,r)=>{"use strict";r.a(e,async(e,n)=>{try{r.d(t,{y:()=>l});var a=r(98785),s=r(47229),i=r(54506),o=e([a]);async function l(e){let t=await (0,a.Xl)(e);if(!t)return;let r=await (0,a.wH)(e,50),n=r.filter(e=>"accepted"===e.feedbackType),o=r.filter(e=>"rejected"===e.feedbackType);if(n.length+o.length<5)return;let l=await (0,s.L)(n.map(e=>({feedbackType:e.feedbackType,editDescription:null,rejectionReason:null,refinedPrompt:e.refinedPrompt,originalPrompt:void 0})),o.map(e=>({feedbackType:e.feedbackType,editDescription:null,rejectionReason:e.rejectionReason,refinedPrompt:e.refinedPrompt,originalPrompt:void 0})),t.masterPrompt??""),d=await (0,i.k)(t.masterPrompt??"",l.recommendations);await (0,a.mZ)(e,{masterPrompt:d,generationSettings:{...t.generationSettings,...null!=l.suggestedSettings.temperature&&{temperature:l.suggestedSettings.temperature},...null!=l.suggestedSettings.negativePrompts&&{negativePrompts:l.suggestedSettings.negativePrompts}}})}a=(o.then?(await o)():o)[0],n()}catch(e){n(e)}})},54506:(e,t,r)=>{"use strict";r.d(t,{k:()=>a});var n=r(47590);async function a(e,t){if(0===t.length)return e;let r=`Current master prompt: ${e}

Recommendations to incorporate:
${t.map(e=>`- ${e}`).join("\n")}

Return the refined master prompt only.`,a=await new n.Ay({apiKey:process.env.OPENAI_API_KEY}).chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:'You refine an illustration style "master prompt" based on feedback recommendations. Keep the prompt concise (2-4 sentences). Output only the refined prompt, no JSON or markdown.'},{role:"user",content:r}],max_tokens:512});return a.choices[0]?.message?.content?.trim()??e}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638,452,915,590],()=>r(18307));module.exports=n})();