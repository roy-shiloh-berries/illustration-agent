(()=>{var e={};e.id=772,e.ids=[772],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},29021:e=>{"use strict";e.exports=require("fs")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},33873:e=>{"use strict";e.exports=require("path")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},64939:e=>{"use strict";e.exports=import("pg")},73024:e=>{"use strict";e.exports=require("node:fs")},57075:e=>{"use strict";e.exports=require("node:stream")},37830:e=>{"use strict";e.exports=require("node:stream/web")},25725:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{patchFetch:()=>d,routeModule:()=>u,serverHooks:()=>f,workAsyncStorage:()=>c,workUnitAsyncStorage:()=>p});var i=r(42706),n=r(28203),s=r(45994),o=r(89989),l=e([o]);o=(l.then?(await l)():l)[0];let u=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/generate/[id]/variations/route",pathname:"/api/generate/[id]/variations",filename:"route",bundlePath:"app/api/generate/[id]/variations/route"},resolvedPagePath:"/Users/berriesdesign/Documents/repos/illustration-agent/src/app/api/generate/[id]/variations/route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:c,workUnitAsyncStorage:p,serverHooks:f}=u;function d(){return(0,s.patchFetch)({workAsyncStorage:c,workUnitAsyncStorage:p})}a()}catch(e){a(e)}})},96487:()=>{},78335:()=>{},89989:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>u});var i=r(39187),n=r(65658),s=r(98785),o=r(9216),l=r(99112),d=e([s,o]);[s,o]=d.then?(await d)():d;let c=n.Ik({editDescription:n.Yj().min(1),preserveAspects:n.YO(n.Yj()).default([])});async function u(e,{params:t}){let{id:r}=await t,a=await (0,s.ZG)(r);if(!a)return i.NextResponse.json({error:"Generation not found"},{status:404});let n=await e.json().catch(()=>({})),d=c.safeParse(n);if(!d.success)return i.NextResponse.json({error:"Invalid body",details:d.error.flatten()},{status:400});let{editDescription:u,preserveAspects:p}=d.data,f=(0,l.$)(a.prompt,u,p),m=(0,l.P)(f),y=a.imageUrl??void 0,g=[];for(let e of["conservative","moderate","bold"])try{let t=await (0,o.W)(a.styleProfileId,m[e],y),i=await (0,s.Gx)({projectId:a.projectId,parentId:a.id,styleProfileId:a.styleProfileId,prompt:t.prompt,imageUrl:t.imageUrl,provider:t.provider,status:"pending",metadata:{editFrom:r,variant:e}});i&&g.push(i.id)}catch(e){}return i.NextResponse.json({variationIds:g,parentId:r})}a()}catch(e){a(e)}})},62693:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.d(t,{db:()=>d});var i=r(78915),n=r(64939),s=r(48590),o=e([n,i]);[n,i]=o.then?(await o)():o;let l=null,d=new Proxy({},{get:(e,t)=>(function(){if(l)return l;let e=process.env.DATABASE_URL;if(!e)throw Error("DATABASE_URL is not set");let t=new n.default.Pool({connectionString:e});return l=(0,i.fd)(t,{schema:s})})()[t]});a()}catch(e){a(e)}})},98785:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.d(t,{$0:()=>h,DV:()=>y,GA:()=>w,Gx:()=>g,Ny:()=>u,Xl:()=>d,ZG:()=>m,ZK:()=>v,jW:()=>p,mZ:()=>f,wH:()=>P});var i=r(47579),n=r(92489),s=r(62693),o=r(48590),l=e([s]);async function d(e){let[t]=await s.db.select().from(o.styleProfiles).where((0,i.eq)(o.styleProfiles.id,e)).limit(1);return t?c(t):null}async function u(e){return(await s.db.select().from(o.styleProfiles).where((0,i.eq)(o.styleProfiles.userId,e)).orderBy((0,n.i)(o.styleProfiles.updatedAt))).map(c)}function c(e){return{id:e.id,name:e.name,userId:e.userId,references:e.references??[],masterPrompt:e.masterPrompt,styleEmbedding:e.styleEmbedding??null,colorPalette:e.colorPalette??[],keyCharacteristics:e.characteristics??[],generationSettings:e.generationSettings??{},createdAt:e.createdAt,updatedAt:e.updatedAt}}async function p(e){let[t]=await s.db.insert(o.styleProfiles).values({userId:e.userId??null,name:e.name,references:e.references??[],masterPrompt:e.masterPrompt??null,styleEmbedding:e.styleEmbedding,colorPalette:e.colorPalette??[],characteristics:e.characteristics??[],generationSettings:e.generationSettings??{}}).returning();return t?c(t):null}async function f(e,t){let r={updatedAt:new Date};void 0!==t.name&&(r.name=t.name),void 0!==t.masterPrompt&&(r.masterPrompt=t.masterPrompt),void 0!==t.references&&(r.references=t.references),void 0!==t.styleEmbedding&&(r.styleEmbedding=t.styleEmbedding),void 0!==t.colorPalette&&(r.colorPalette=t.colorPalette),void 0!==t.characteristics&&(r.characteristics=t.characteristics),void 0!==t.generationSettings&&(r.generationSettings=t.generationSettings);let[a]=await s.db.update(o.styleProfiles).set(r).where((0,i.eq)(o.styleProfiles.id,e)).returning();return a?c(a):null}async function m(e){let[t]=await s.db.select().from(o.generations).where((0,i.eq)(o.generations.id,e)).limit(1);return t??null}async function y(e){let t=await m(e);if(!t)return null;let r=await s.db.select().from(o.generations).where((0,i.eq)(o.generations.parentId,e)),a=await Promise.all(r.map(e=>y(e.id)));return{...t,children:a.filter(e=>null!==e)}}async function g(e){let t=await s.db.insert(o.generations).values({projectId:e.projectId??null,parentId:e.parentId??null,styleProfileId:e.styleProfileId,prompt:e.prompt,imageUrl:e.imageUrl??null,provider:e.provider??null,status:e.status??"pending",metadata:e.metadata??{}}).returning();return Array.isArray(t)?t[0]:null}async function h(e){let[t]=await s.db.insert(o.feedback).values(e).returning();return t}async function w(e){let[t]=await s.db.select().from(o.canvasState).where((0,i.eq)(o.canvasState.projectId,e)).limit(1);return t??null}async function v(e,t){await s.db.insert(o.canvasState).values({projectId:e,state:t}).onConflictDoUpdate({target:o.canvasState.projectId,set:{state:t,updatedAt:new Date}})}async function P(e,t){let r=(await s.db.select({id:o.generations.id}).from(o.generations).where((0,i.eq)(o.generations.styleProfileId,e)).orderBy((0,n.i)(o.generations.createdAt)).limit(100)).map(e=>e.id);return 0===r.length?[]:s.db.select().from(o.feedback).where((0,i.RV)(o.feedback.generationId,r)).orderBy((0,n.i)(o.feedback.createdAt)).limit(t)}s=(l.then?(await l)():l)[0],a()}catch(e){a(e)}})},48590:(e,t,r)=>{"use strict";r.r(t),r.d(t,{canvasState:()=>g,feedback:()=>m,generations:()=>f,providerPerformance:()=>y,styleProfiles:()=>p,users:()=>c});var a=r(78585),i=r(60011),n=r(99063),s=r(32590),o=r(44799),l=r(57102),d=r(9848),u=r(43796);let c=(0,a.cJ)("users",{id:(0,i.uR)("id").primaryKey().defaultRandom(),email:(0,n.yf)("email",{length:255}).notNull().unique(),createdAt:(0,s.vE)("created_at").defaultNow().notNull(),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()}),p=(0,a.cJ)("style_profiles",{id:(0,i.uR)("id").primaryKey().defaultRandom(),userId:(0,i.uR)("user_id").references(()=>c.id),name:(0,n.yf)("name",{length:255}).notNull(),masterPrompt:(0,o.Qq)("master_prompt"),styleEmbedding:(0,l.Fx)("style_embedding").$type(),colorPalette:(0,l.Fx)("color_palette").$type().default([]),characteristics:(0,l.Fx)("characteristics").$type().default([]),generationSettings:(0,l.Fx)("generation_settings").$type().default({}),references:(0,l.Fx)("references").$type().default([]),createdAt:(0,s.vE)("created_at").defaultNow().notNull(),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()}),f=(0,a.cJ)("generations",{id:(0,i.uR)("id").primaryKey().defaultRandom(),projectId:(0,i.uR)("project_id"),parentId:(0,i.uR)("parent_id"),styleProfileId:(0,i.uR)("style_profile_id").references(()=>p.id).notNull(),prompt:(0,o.Qq)("prompt").notNull(),imageUrl:(0,n.yf)("image_url",{length:512}),provider:(0,n.yf)("provider",{length:50}),status:(0,n.yf)("status",{length:20}).notNull().default("pending"),metadata:(0,l.Fx)("metadata").$type().default({}),createdAt:(0,s.vE)("created_at").defaultNow().notNull()}),m=(0,a.cJ)("feedback",{id:(0,i.uR)("id").primaryKey().defaultRandom(),generationId:(0,i.uR)("generation_id").references(()=>f.id).notNull(),feedbackType:(0,n.yf)("feedback_type",{length:20}).notNull(),editDescription:(0,o.Qq)("edit_description"),preserveAspects:(0,l.Fx)("preserve_aspects").$type(),rejectionReason:(0,o.Qq)("rejection_reason"),refinedPrompt:(0,o.Qq)("refined_prompt"),createdAt:(0,s.vE)("created_at").defaultNow().notNull()}),y=(0,a.cJ)("provider_performance",{id:(0,i.uR)("id").primaryKey().defaultRandom(),styleProfileId:(0,i.uR)("style_profile_id").references(()=>p.id),providerName:(0,n.yf)("provider_name",{length:50}).notNull(),taskType:(0,n.yf)("task_type",{length:50}).notNull(),successCount:(0,d.nd)("success_count").notNull().default(0),failureCount:(0,d.nd)("failure_count").notNull().default(0),avgQualityScore:(0,u.x)("avg_quality_score"),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()}),g=(0,a.cJ)("canvas_state",{projectId:(0,i.uR)("project_id").primaryKey(),state:(0,l.Fx)("state").$type().notNull(),updatedAt:(0,s.vE)("updated_at").defaultNow().notNull()})},48108:(e,t,r)=>{"use strict";r.d(t,{b:()=>n});let a=process.env.FLUX_BASE_URL??"https://api.bfl.ml",i=process.env.FLUX_API_KEY??process.env.TOGETHER_API_KEY;async function n(e){if(!i)throw Error("FLUX_API_KEY or TOGETHER_API_KEY is not set");let t={prompt:e.prompt,negative_prompt:e.negativePrompt??"blurry, low quality",image:e.styleImageUrl??void 0,width:e.width??1024,height:e.height??1024,num_inference_steps:e.numInferenceSteps??28,seed:e.seed??Math.floor(0x100000000*Math.random())},r=await fetch(`${a}/v1/images/generations`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(t)});if(!r.ok){let e=await r.text();throw Error(`Flux API error: ${r.status} ${e}`)}let n=await r.json(),s=n.data?.[0];if(!s?.url&&!s?.b64_json)throw Error("Flux API returned no image");return{imageUrl:s.url??`data:image/png;base64,${s.b64_json}`,seed:t.seed}}},74044:(e,t,r)=>{"use strict";r.d(t,{S:()=>i});var a=r(47590);async function i(e){let t=await new a.Ay({apiKey:process.env.OPENAI_API_KEY}).images.generate({model:"dall-e-3",prompt:e.prompt.slice(0,4e3),n:1,size:e.size??"1024x1024",quality:e.quality??"standard",response_format:"url"}),r=t.data?.[0]?.url;if(!r)throw Error("DALL-E returned no image");return{imageUrl:r}}},46540:(e,t,r)=>{"use strict";r.d(t,{j:()=>i});let a=process.env.REPLICATE_API_KEY;async function i(e){if(!a)throw Error("REPLICATE_API_KEY is not set");let t=await fetch("https://api.replicate.com/v1/predictions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({version:"stability-ai/sdxl:39a7a83a4a7b2a7a4a7b2a7a4a7b2a7a".split(":")[1]??"latest",input:{prompt:e.prompt,negative_prompt:e.negativePrompt??"blurry, low quality",width:e.width??1024,height:e.height??1024}})});if(!t.ok){let e=await t.text();throw Error(`Replicate API error: ${t.status} ${e}`)}let r=await t.json(),i=null,n=r.urls?.get;if(!n)throw Error("Replicate returned no get URL");for(let e=0;e<60;e++){await new Promise(e=>setTimeout(e,2e3));let e=await fetch(n,{headers:{Authorization:`Bearer ${a}`}});if("succeeded"===(i=await e.json()).status&&i.output)return{imageUrl:Array.isArray(i.output)?i.output[0]:i.output};if("failed"===i.status)throw Error("Replicate prediction failed")}throw Error("Replicate prediction timed out")}},9216:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.d(t,{W:()=>c});var i=r(98785),n=r(41522),s=r(48108),o=r(74044),l=r(46540),d=e([i]);i=(d.then?(await d)():d)[0];let p=["flux","dalle","replicate"];async function u(e,t,r,a){try{if("flux"===e){let e=await (0,s.b)({prompt:t,negativePrompt:r,styleImageUrl:a,width:1024,height:1024});return{imageUrl:e.imageUrl,provider:"flux",prompt:t,seed:e.seed}}if("dalle"===e)return{imageUrl:(await (0,o.S)({prompt:t})).imageUrl,provider:"dalle",prompt:t};if("replicate"===e)return{imageUrl:(await (0,l.j)({prompt:t,negativePrompt:r})).imageUrl,provider:"replicate",prompt:t}}catch(e){}return null}async function c(e,t,r){let a=await (0,i.Xl)(e);if(!a)throw Error("Style profile not found");let s=a.masterPrompt??"",o=a.generationSettings?.negativePrompts??[],{prompt:l,negativePrompt:d}=(0,n.T)(s,t,o);for(let e of p){let t=await u(e,l,d,r);if(t)return t}throw Error("All image providers failed")}a()}catch(e){a(e)}})},41522:(e,t,r)=>{"use strict";function a(e,t,r){let a=[],i=new Set,n=new Set,s=new Set(t);for(let t of e){let e=t.analysis;e&&(e.styleDescriptors.forEach(e=>i.add(e)),e.technicalAttributes.forEach(e=>n.add(e)),e.colors.forEach(e=>s.add(e)))}for(let t of(r.forEach(e=>i.add(e)),s.size>0&&a.push(`Color palette: ${Array.from(s).slice(0,12).join(", ")}.`),i.size>0&&a.push(`Style: ${Array.from(i).slice(0,15).join(", ")}.`),n.size>0&&a.push(`Technical: ${Array.from(n).slice(0,10).join(", ")}.`),e))if(t.analysis?.composition){a.push(`Composition note: ${t.analysis.composition}.`);break}return a.join(" ").trim()||"Consistent illustration style."}function i(e,t,r=[]){return{prompt:`${e} ${t}`.trim(),negativePrompt:r.length>0?r.join(", "):"blurry, low quality, inconsistent style, text, watermark"}}r.d(t,{T:()=>i,p:()=>a})},99112:(e,t,r)=>{"use strict";function a(e,t,r){let a=r.length>0?` Keep these unchanged: ${r.join(", ")}.`:"";return`${e} Edit: ${t}.${a}`.trim()}function i(e){return{conservative:`${e} Apply the edit subtly and minimally.`,moderate:e,bold:`${e} Apply the edit boldly and noticeably.`}}r.d(t,{$:()=>a,P:()=>i})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,452,915,658,590],()=>r(25725));module.exports=a})();