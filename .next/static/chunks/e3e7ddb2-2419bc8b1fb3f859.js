"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[51],{470:(e,t,i)=>{i.d(t,{K:()=>q});var s=i(4229),r=i(1830),n=i(7906),a=i(2341),h=i(5778),o=i(7650),p=i(2669),l=i(5801),g=i(1295),d=i(5793),u=i(2549),c=i(8352),S=i(6493),f=i(483),m=i(6810),y=i(6834),I=i(7377),P=i(8492),C=i(959),w=i(4744),_=i(9172),x=i(6326),T=i(9946),b=i(1524),E=i(1378),v=i(4955),k=i(2864),B=i(3552),A=i(4225),M=i(363),F=i(8410),O=i(6404),U=i(4635),z=i(8829),R=i(7838),W=i(3179),V=i(8984),K=i(7101),L=i(1789),D=i(3438),G=i(3220),N=i(9748),H=i(4818),X=Object.defineProperty,Y=Object.getOwnPropertyDescriptor,Z=(e,t,i,s)=>{for(var r,n=s>1?void 0:s?Y(t,i):t,a=e.length-1;a>=0;a--)(r=e[a])&&(n=(s?r(t,i,n):r(n))||n);return s&&n&&X(t,i,n),n};class q extends h{constructor({store:e,user:t,shapeUtils:i,bindingUtils:s,tools:r,getContainer:h,cameraOptions:o,initialState:p,autoFocus:l,inferDarkMode:f,options:m}){super(),this.options={...S._,...m},this.store=e,this.disposables.add(this.store.dispose.bind(this.store)),this.history=new V.c({store:e,annotateError:e=>{this.annotateError(e,{origin:"history.batch",willCrashApp:!0}),this.crash(e)}}),this.snaps=new L.m(this),this.timers=new a.xl,this.disposables.add(this.timers.dispose.bind(this.timers)),this._cameraOptions.set({...c.zd,...o}),this.user=new N.f(t??(0,g.i)(),f??!1),this.getContainer=h??(()=>document.body),this.textMeasure=new D.T(this),this._tickManager=new G.D(this);class y extends H.y{static initial=p??""}this.root=new y(this),this.root.children={};let I=(0,u.u)(i),P={},C={},w=new Map;for(let e of I){let t=new e(this);P[e.type]=t;let i=(0,n.lg)(e.props??{});for(let t of(C[e.type]=i,i.keys()))if(w.has(t.id)){if(w.get(t.id)!==t)throw Error(`Multiple style props with id "${t.id}" in use. Style prop IDs must be unique.`)}else w.set(t.id,t)}this.shapeUtils=P,this.styleProps=C;let _=(0,d.t)(s),x={};for(let e of _){let t=new e(this);x[e.type]=t}for(let e of(this.bindingUtils=x,[...r])){if((0,a.mQ)(this.root.children,e.id))throw Error(`Can't override tool with id "${e.id}"`);this.root.children[e.id]=new e(this,this.root)}this.environment=new R.N(this),this.scribbles=new K.y(this);let T=(e,t)=>{let i=null,s=e.selectedShapeIds.filter(e=>!t.has(e));s.length!==e.selectedShapeIds.length&&(i||(i={...e}),i.selectedShapeIds=s);let r=e.erasingShapeIds.filter(e=>!t.has(e));r.length!==e.erasingShapeIds.length&&(i||(i={...e}),i.erasingShapeIds=r),e.hoveredShapeId&&t.has(e.hoveredShapeId)&&(i||(i={...e}),i.hoveredShapeId=null),e.editingShapeId&&t.has(e.editingShapeId)&&(i||(i={...e}),i.editingShapeId=null);let n=e.hintingShapeIds.filter(e=>!t.has(e));return n.length!==e.hintingShapeIds.length&&(i||(i={...e}),i.hintingShapeIds=n),e.focusedGroupId&&t.has(e.focusedGroupId)&&(i||(i={...e}),i.focusedGroupId=null),i};this.sideEffects=this.store.sideEffects;let b=new Map,E=new Set,v=new Set,k=new Set;if(this.disposables.add(this.sideEffects.registerOperationCompleteHandler(()=>{for(let e of(E.clear(),v)){v.delete(e);let t=this.getShape(e);if(!t)continue;let i=this.getShapeUtil(t),s=i.onChildrenChange?.(t);s?.length&&this.updateShapes(s)}if(k.size){let e=k;for(let t of(k=new Set,e)){let e=this.getBindingUtil(t);e.onOperationComplete?.()}}if(b.size){let e=b;for(let t of(b=new Map,e.values()))this.getBindingUtil(t.binding).onAfterDelete?.(t)}this.emit("update")})),this.disposables.add(this.sideEffects.register({shape:{afterChange:(e,t)=>{for(let i of this.getBindingsInvolvingShape(t))k.add(i.type),i.fromId===t.id&&this.getBindingUtil(i).onAfterChangeFromShape?.({binding:i,shapeBefore:e,shapeAfter:t}),i.toId===t.id&&this.getBindingUtil(i).onAfterChangeToShape?.({binding:i,shapeBefore:e,shapeAfter:t});if(e.parentId!==t.parentId){let e=e=>{let t=this.getShape(e);if(t)for(let e of this.getBindingsInvolvingShape(t))k.add(e.type),e.fromId===t.id&&this.getBindingUtil(e).onAfterChangeFromShape?.({binding:e,shapeBefore:t,shapeAfter:t}),e.toId===t.id&&this.getBindingUtil(e).onAfterChangeToShape?.({binding:e,shapeBefore:t,shapeAfter:t})};e(t.id),this.visitDescendants(t.id,e)}if(e.parentId!==t.parentId&&(0,n.xh)(t.parentId)){let i=new Set([e.id]);for(let s of(this.visitDescendants(e.id,e=>{i.add(e)}),this.getPageStates())){if(s.pageId===t.parentId)continue;let e=T(s,i);e&&this.store.put([e])}}e.parentId&&(0,n.vc)(e.parentId)&&v.add(e.parentId),t.parentId!==e.parentId&&(0,n.vc)(t.parentId)&&v.add(t.parentId)},beforeDelete:e=>{if(E.has(e.id))return;e.parentId&&(0,n.vc)(e.parentId)&&v.add(e.parentId),E.add(e.id);let t=[];for(let i of this.getBindingsInvolvingShape(e)){k.add(i.type),t.push(i.id);let s=this.getBindingUtil(i);i.fromId===e.id?(s.onBeforeIsolateToShape?.({binding:i,removedShape:e}),s.onBeforeDeleteFromShape?.({binding:i,shape:e})):(s.onBeforeIsolateFromShape?.({binding:i,removedShape:e}),s.onBeforeDeleteToShape?.({binding:i,shape:e}))}t.length&&this.deleteBindings(t);let i=new Set([e.id]),s=(0,a.oE)(this.getPageStates().map(e=>T(e,i)));s.length&&this.store.put(s)}},binding:{beforeCreate:e=>this.getBindingUtil(e).onBeforeCreate?.({binding:e})||e,afterCreate:e=>{k.add(e.type),this.getBindingUtil(e).onAfterCreate?.({binding:e})},beforeChange:(e,t)=>this.getBindingUtil(t).onBeforeChange?.({bindingBefore:e,bindingAfter:t})||t,afterChange:(e,t)=>{k.add(t.type),this.getBindingUtil(t).onAfterChange?.({bindingBefore:e,bindingAfter:t})},beforeDelete:e=>{this.getBindingUtil(e).onBeforeDelete?.({binding:e})},afterDelete:e=>{this.getBindingUtil(e).onAfterDelete?.({binding:e}),k.add(e.type)}},page:{afterCreate:e=>{let t=n.Xu.createId(e.id),i=n.jA.createId(e.id);this.store.has(t)||this.store.put([n.Xu.create({id:t})]),this.store.has(i)||this.store.put([n.jA.create({id:i,pageId:e.id})])},afterDelete:(e,t)=>{if(this.getInstanceState()?.currentPageId===e.id){let i=this.getPages().find(t=>t.id!==e.id)?.id;i?this.store.put([{...this.getInstanceState(),currentPageId:i}]):"user"===t&&this.store.ensureStoreIsUsable()}let i=n.Xu.createId(e.id),s=n.jA.createId(e.id);this.store.remove([i,s])}},instance:{afterChange:(e,t,i)=>{if(!this.store.has(t.currentPageId)){let s=this.store.has(e.currentPageId)?e.currentPageId:this.getPages()[0]?.id;s?this.store.update(t.id,e=>({...e,currentPageId:s})):"user"===i&&this.store.ensureStoreIsUsable()}}},instance_page_state:{afterChange:(e,t)=>{if(e?.selectedShapeIds!==t?.selectedShapeIds){let e=t.selectedShapeIds.filter(e=>{let i=this.getShape(e)?.parentId;for(;(0,n.vc)(i);){if(t.selectedShapeIds.includes(i))return!1;i=this.getShape(i)?.parentId}return!0}),i=null;if(e.length>0){let t=this.findCommonAncestor((0,a.oE)(e.map(e=>this.getShape(e))),e=>this.isShapeOfType(e,"group"));t&&(i=t)}else t?.focusedGroupId&&(i=t.focusedGroupId);(e.length!==t.selectedShapeIds.length||i!==t.focusedGroupId)&&this.store.put([{...t,selectedShapeIds:e,focusedGroupId:i??null}])}}}})),this._currentPageShapeIds=(0,F.A)(this.store,()=>this.getCurrentPageId()),this._parentIdsToChildIds=(0,M.i)(this.store),this.disposables.add(this.store.listen(e=>{this.emit("change",e)})),this.disposables.add(this.history.dispose),this.run(()=>{this.store.ensureStoreIsUsable(),this._updateCurrentPageState({editingShapeId:null,hoveredShapeId:null,erasingShapeIds:[]})},{history:"ignore"}),p&&void 0===this.root.children[p])throw Error(`No state found for initialState "${p}".`);this.root.enter(void 0,"initial"),this.edgeScrollManager=new z.w(this),this.focusManager=new W.c(this,l),this.disposables.add(this.focusManager.dispose.bind(this.focusManager)),this.getInstanceState().followingUserId&&this.stopFollowingUser(),this.on("tick",this._flushEventsForTick),this.timers.requestAnimationFrame(()=>{this._tickManager.start()}),this.performanceTracker=new a.f6}options;store;root;disposables=new Set;isDisposed=!1;_tickManager;snaps;timers;user;textMeasure;environment;scribbles;sideEffects;edgeScrollManager;focusManager;getContainer;dispose(){this.disposables.forEach(e=>e()),this.disposables.clear(),this.isDisposed=!0}shapeUtils;styleProps;getShapeUtil(e){let t="string"==typeof e?e:e.type,i=(0,a.g5)(this.shapeUtils,t);return(0,a.vA)(i,`No shape util found for type "${t}"`),i}bindingUtils;getBindingUtil(e){let t="string"==typeof e?e:e.type,i=(0,a.g5)(this.bindingUtils,t);return(0,a.vA)(i,`No binding util found for type "${t}"`),i}history;undo(){return this._flushEventsForTick(0),this.complete(),this.history.undo(),this}getCanUndo(){return this.history.getNumUndos()>0}redo(){return this._flushEventsForTick(0),this.complete(),this.history.redo(),this}clearHistory(){return this.history.clear(),this}getCanRedo(){return this.history.getNumRedos()>0}mark(e){return this.history.mark(e),this}squashToMark(e){return this.history.squashToMark(e),this}bail(){return this.history.bail(),this}bailToMark(e){return this.history.bailToMark(e),this}_shouldIgnoreShapeLock=!1;run(e,t){let i=this._shouldIgnoreShapeLock;this._shouldIgnoreShapeLock=t?.ignoreShapeLock??i;try{this.history.batch(e,t)}finally{this._shouldIgnoreShapeLock=i}return this}batch(e,t){return this.run(e,t)}annotateError(e,{origin:t,willCrashApp:i,tags:s,extras:r}){let n=this.createErrorAnnotations(t,i);return(0,a.TF)(e,{tags:{...n.tags,...s},extras:{...n.extras,...r}}),i&&this.store.markAsPossiblyCorrupted(),this}createErrorAnnotations(e,t){try{let i=this.getEditingShapeId();return{tags:{origin:e,willCrashApp:t},extras:{activeStateNode:this.root.getPath(),selectedShapes:this.getSelectedShapes(),editingShape:i?this.getShape(i):void 0,inputs:this.inputs}}}catch{return{tags:{origin:e,willCrashApp:t},extras:{}}}}_crashingError=null;getCrashingError(){return this._crashingError}crash(e){return this._crashingError=e,this.store.markAsPossiblyCorrupted(),this.emit("crash",{error:e}),this}getPath(){return this.root.getPath().split("root.")[1]}isIn(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)return!0;let s=i.getCurrent();if(s?.id===e){if(0===t.length)return!0;i=s;continue}break}return!1}isInAny(...e){return e.some(e=>this.isIn(e))}setCurrentTool(e,t={}){return this.root.transition(e,t),this}getCurrentTool(){return this.root.getCurrent()}getCurrentToolId(){let e=this.getCurrentTool();return e?e.getCurrentToolIdMask()??e.id:""}getStateDescendant(e){let t=e.split(".").reverse(),i=this.root;for(;t.length>0;){let e=t.pop();if(!e)break;let s=i.children?.[e];if(!s)return;i=s}return i}getDocumentSettings(){return this.store.get(n.yI)}updateDocumentSettings(e){return this.run(()=>{this.store.put([{...this.getDocumentSettings(),...e}])},{history:"ignore"}),this}getInstanceState(){return this.store.get(n.O9)}updateInstanceState(e,t){return this._updateInstanceState(e,{history:"ignore",...t}),void 0!==e.isChangingStyle&&(clearTimeout(this._isChangingStyleTimeout),!0===e.isChangingStyle&&(this._isChangingStyleTimeout=this.timers.setTimeout(()=>{this._updateInstanceState({isChangingStyle:!1},{history:"ignore"})},2e3))),this}_updateInstanceState=(e,t)=>{this.run(()=>{this.store.put([{...this.getInstanceState(),...e}])},t)};_isChangingStyleTimeout=-1;getOpenMenus(){return this.getInstanceState().openMenus}addOpenMenu(e){let t=new Set(this.getOpenMenus());return t.has(e)||(t.add(e),this.updateInstanceState({openMenus:[...t]})),this}deleteOpenMenu(e){let t=new Set(this.getOpenMenus());return t.has(e)&&(t.delete(e),this.updateInstanceState({openMenus:[...t]})),this}clearOpenMenus(){return this.getOpenMenus().length&&this.updateInstanceState({openMenus:[]}),this}getIsMenuOpen(){return this.getOpenMenus().length>0}setCursor=e=>(this.updateInstanceState({cursor:{...this.getInstanceState().cursor,...e}}),this);getPageStates(){return this._getPageStatesQuery().get()}_getPageStatesQuery(){return this.store.query.records("instance_page_state")}getCurrentPageState(){return this.store.get(this._getCurrentPageStateId())}_getCurrentPageStateId(){return n.jA.createId(this.getCurrentPageId())}updateCurrentPageState(e){return this._updateCurrentPageState(e),this}_updateCurrentPageState=e=>{this.store.update(e.id??this.getCurrentPageState().id,t=>({...t,...e}))};getSelectedShapeIds(){return this.getCurrentPageState().selectedShapeIds}getSelectedShapes(){let{selectedShapeIds:e}=this.getCurrentPageState();return(0,a.oE)(e.map(e=>this.store.get(e)))}setSelectedShapes(e){return this.run(()=>{let t=e.map(e=>"string"==typeof e?e:e.id),{selectedShapeIds:i}=this.getCurrentPageState(),s=new Set(i);if(t.length===s.size&&t.every(e=>s.has(e)))return null;this.store.put([{...this.getCurrentPageState(),selectedShapeIds:t}])},{history:"record-preserveRedoStack"})}isAncestorSelected(e){let t="string"==typeof e?e:e?.id??null,i=this.getShape(t);if(!i)return!1;let s=this.getSelectedShapeIds();return!!this.findShapeAncestor(i,e=>s.includes(e.id))}select(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.setSelectedShapes(t),this}deselect(...e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this.getSelectedShapeIds();return i.length>0&&t.length>0&&this.setSelectedShapes(i.filter(e=>!t.includes(e))),this}selectAll(){let e=this.getSortedChildIdsForParent(this.getCurrentPageId());return e.length<=0||this.setSelectedShapes(this._getUnlockedShapeIds(e)),this}selectNone(){return this.getSelectedShapeIds().length>0&&this.setSelectedShapes([]),this}getOnlySelectedShapeId(){return this.getOnlySelectedShape()?.id??null}getOnlySelectedShape(){let e=this.getSelectedShapes();return 1===e.length?e[0]:null}getSelectionPageBounds(){let e=this.getCurrentPageState().selectedShapeIds;return 0===e.length?null:f.az.Common((0,a.oE)(e.map(e=>this.getShapePageBounds(e))))}getSelectionRotation(){let e=this.getSelectedShapeIds(),t=!1,i=0;for(let s=0,r=e.length;s<r;s++){let r=this.getShapePageTransform(e[s]);if(r){if(t){if(r.rotation()!==i)return 0}else t=!0,i=r.rotation()}}return i}getSelectionRotatedPageBounds(){let e=this.getSelectedShapeIds();if(0===e.length)return;let t=this.getSelectionRotation();if(0===t)return this.getSelectionPageBounds();if(1===e.length){let t=this.getShapeGeometry(e[0]).bounds.clone(),i=this.getShapePageTransform(e[0]);return t.point=i.applyToPoint(t.point),t}let i=f.az.FromPoints(this.getSelectedShapeIds().flatMap(e=>{let t=this.getShapePageTransform(e);return t?t.applyToPoints(this.getShapeGeometry(e).bounds.corners):[]}).map(e=>e.rot(-t)));return i.point=i.point.rot(t),i}getSelectionRotatedScreenBounds(){let e=this.getSelectionRotatedPageBounds();if(!e)return;let{x:t,y:i}=this.pageToScreen(e.point),s=this.getZoomLevel();return new f.az(t,i,e.width*s,e.height*s)}getFocusedGroupId(){return this.getCurrentPageState().focusedGroupId??this.getCurrentPageId()}getFocusedGroup(){let e=this.getFocusedGroupId();return e?this.getShape(e):void 0}setFocusedGroup(e){let t="string"==typeof e?e:e?.id??null;if(null!==t){let e=this.getShape(t);if(!e)throw Error(`Editor.setFocusedGroup: Shape with id ${t} does not exist`);if(!this.isShapeOfType(e,"group"))throw Error(`Editor.setFocusedGroup: Cannot set focused group to shape of type ${e.type}`)}return t===this.getFocusedGroupId()?this:this.run(()=>{this.store.update(this.getCurrentPageState().id,e=>({...e,focusedGroupId:t}))},{history:"record-preserveRedoStack"})}popFocusedGroupId(){let e=this.getFocusedGroup();if(e){let t=this.findShapeAncestor(e,e=>this.isShapeOfType(e,"group"));this.setFocusedGroup(t?.id??null),this.select(e.id)}else this.setFocusedGroup(null),this.selectNone();return this}getEditingShapeId(){return this.getCurrentPageState().editingShapeId}getEditingShape(){let e=this.getEditingShapeId();return e?this.getShape(e):void 0}setEditingShape(e){let t="string"==typeof e?e:e?.id??null;if(t!==this.getEditingShapeId()){if(t){let e=this.getShape(t);if(e&&this.getShapeUtil(e).canEdit(e))return this.run(()=>{this._updateCurrentPageState({editingShapeId:t})},{history:"ignore"}),this}this.run(()=>{this._updateCurrentPageState({editingShapeId:null})},{history:"ignore"})}return this}getHoveredShapeId(){return this.getCurrentPageState().hoveredShapeId}getHoveredShape(){let e=this.getHoveredShapeId();return e?this.getShape(e):void 0}setHoveredShape(e){let t="string"==typeof e?e:e?.id??null;return t===this.getHoveredShapeId()||this.run(()=>{this.updateCurrentPageState({hoveredShapeId:t})},{history:"ignore"}),this}getHintingShapeIds(){return this.getCurrentPageState().hintingShapeIds}getHintingShape(){let e=this.getHintingShapeIds();return(0,a.oE)(e.map(e=>this.getShape(e)))}setHintingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);return this.run(()=>{this._updateCurrentPageState({hintingShapeIds:(0,a.Qq)(t)})},{history:"ignore"}),this}getErasingShapeIds(){return this.getCurrentPageState().erasingShapeIds}getErasingShapes(){let e=this.getErasingShapeIds();return(0,a.oE)(e.map(e=>this.getShape(e)))}setErasingShapes(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);t.sort();let i=this.getErasingShapeIds();return this.run(()=>{if(t.length===i.length){for(let e=0;e<t.length;e++)if(t[e]!==i[e]){this._updateCurrentPageState({erasingShapeIds:t});break}}else this._updateCurrentPageState({erasingShapeIds:t})},{history:"ignore"}),this}getCroppingShapeId(){return this.getCurrentPageState().croppingShapeId}setCroppingShape(e){let t="string"==typeof e?e:e?.id??null;return t!==this.getCroppingShapeId()&&this.run(()=>{if(t){let e=this.getShape(t),i=this.getShapeUtil(e);e&&i.canCrop(e)&&this.updateCurrentPageState({croppingShapeId:t})}else this.updateCurrentPageState({croppingShapeId:null})},{history:"ignore"}),this}_unsafe_getCameraId(){return n.Xu.createId(this.getCurrentPageId())}getCamera(){let e=this.store.get(this._unsafe_getCameraId());if(this._isLockedOnFollowingUser.get()){let t=this.getCameraForFollowing();if(t)return{...e,...t}}return e}getViewportPageBoundsForFollowing(){let e=this.getInstanceState().followingUserId;if(!e)return null;let t=this.getCollaborators().find(t=>t.userId===e);if(!t)return null;let{w:i,h:s}=t.screenBounds,{x:r,y:n,z:a}=t.camera,h=new f.az(-r,-n,i/a,s/a),o=this.getViewportScreenBounds().clone(),p=o.width/o.height;return o.width=h.width,o.height=o.width/p,o.height<h.height&&(o.height=h.height,o.width=o.height*p),o.center=h.center,o}getCameraForFollowing(){let e=this.getViewportPageBoundsForFollowing();return e?{x:-e.x,y:-e.y,z:this.getViewportScreenBounds().w/e.width}:null}getZoomLevel(){return this.getCamera().z}getInitialZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.initialZoom)return 1;let{zx:t,zy:i}=J(this,e);switch(e.constraints.initialZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,a.h6)(e.constraints.initialZoom)}}getBaseZoom(){let e=this.getCameraOptions();if(!e.constraints||"default"===e.constraints.baseZoom)return 1;let{zx:t,zy:i}=J(this,e);switch(e.constraints.baseZoom){case"fit-min":return Math.max(t,i);case"fit-max":return Math.min(t,i);case"fit-x":return t;case"fit-y":return i;case"fit-min-100":return Math.min(1,Math.max(t,i));case"fit-max-100":return Math.min(1,Math.min(t,i));case"fit-x-100":return Math.min(1,t);case"fit-y-100":return Math.min(1,i);default:throw(0,a.h6)(e.constraints.baseZoom)}}_cameraOptions=(0,s.eU)("camera options",c.zd);getCameraOptions(){return this._cameraOptions.get()}setCameraOptions(e){let t=(0,a.pN)({...this._cameraOptions.__unsafe__getWithoutCapture(),...e});return t.zoomSteps?.length<1&&(t.zoomSteps=[1]),this._cameraOptions.set(t),this}getConstrainedCamera(e,t){let i=this.getCamera(),{x:s,y:r,z:n=i.z}=e;if(!t?.force){let e=this.getCameraOptions(),h=e.zoomSteps[0],o=(0,a.HV)(e.zoomSteps),p=this.getViewportScreenBounds();if(e.constraints){let{constraints:l}=e,g=Math.min(l.padding.y,p.w/2),d=Math.min(l.padding.x,p.h/2),u=f.az.From(e.constraints.bounds),c=(p.w-2*d)/u.w,S=(p.h-2*g)/u.h,m=this.getBaseZoom(),y=o*m,I=h*m;if(t?.reset&&(n=this.getInitialZoom()),n<I||n>y){let{x:e,y:t,z:a}=i,h=-e+p.w/a/2,o=-t+p.h/a/2;n=(0,w.qE)(n,I,y);let l=-e+p.w/n/2,g=-t+p.h/n/2;s=e+l-h,r=t+g-o}let P=d/n-u.x,C=g/n-u.y,_=(p.w-2*d)/n-u.w,x=(p.h-2*g)/n-u.h,T=P+_*l.origin.x,b=C+x*l.origin.y,E="string"==typeof l.behavior?l.behavior:l.behavior.x,v="string"==typeof l.behavior?l.behavior:l.behavior.y;if(t?.reset)s=T,r=b;else{switch(E){case"fixed":s=T;break;case"contain":s=n<c?T:(0,w.qE)(s,P+_,P);break;case"inside":s=n<c?(0,w.qE)(s,P,(p.w-d)/n-u.w):(0,w.qE)(s,P+_,P);break;case"outside":s=(0,w.qE)(s,d/n-u.w,(p.w-d)/n);break;case"free":break;default:throw(0,a.h6)(E)}switch(v){case"fixed":r=b;break;case"contain":r=n<S?b:(0,w.qE)(r,C+x,C);break;case"inside":r=n<S?(0,w.qE)(r,C,(p.h-g)/n-u.h):(0,w.qE)(r,C+x,C);break;case"outside":r=(0,w.qE)(r,g/n-u.h,(p.h-g)/n);break;case"free":break;default:throw(0,a.h6)(v)}}}else if(n>o||n<h){let{x:e,y:t,z:a}=i;n=(0,w.qE)(n,h,o),s=e+(-e+p.w/n/2)-(-e+p.w/a/2),r=t+(-t+p.h/n/2)-(-t+p.h/a/2)}}return{x:s,y:r,z:n}}_setCamera(e,t){let i=this.getCamera(),{x:r,y:a,z:h}=this.getConstrainedCamera(e,t);return i.x===r&&i.y===a&&i.z===h||(0,s.hL)(()=>{let e={...i,x:r,y:a,z:h};this.run(()=>{this.store.put([e])},{history:"ignore"});let{currentScreenPoint:s,currentPagePoint:o}=this.inputs,{screenBounds:p}=this.store.unsafeGetWithoutCapture(n.O9);if(s.x/h-r!==o.x||s.y/h-a!==o.y){let e={type:"pointer",target:"canvas",name:"pointer_move",point:y.l.AddXY(s,p.x,p.y),pointerId:c.zm.CAMERA_MOVE,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,shiftKey:this.inputs.shiftKey,button:0,isPen:this.getInstanceState().isPenMode??!1};t?.immediate?this._flushEventForTick(e):this.dispatch(e)}this._tickCameraState()}),this}setCamera(e,t){let{isLocked:i}=this._cameraOptions.__unsafe__getWithoutCapture();if(i&&!t?.force)return this;this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser();let s=y.l.Cast(e);Number.isFinite(s.x)||(s.x=0),Number.isFinite(s.y)||(s.y=0),void 0!==s.z&&Number.isFinite(s.z)||(e.z=this.getZoomLevel());let r=this.getConstrainedCamera(s,t);if(t?.animation){let{width:e,height:i}=this.getViewportScreenBounds();this._animateToViewport(new f.az(-r.x,-r.y,e/r.z,i/r.z),t)}else this._setCamera(r,{...t,force:!0});return this}centerOnPoint(e,t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{width:s,height:r}=this.getViewportPageBounds();return this.setCamera(new y.l(-(e.x-s/2),-(e.y-r/2),this.getCamera().z),t),this}zoomToFit(e){let t=[...this.getCurrentPageShapeIds()];if(t.length<=0)return this;let i=f.az.Common((0,a.oE)(t.map(e=>this.getShapePageBounds(e))));return this.zoomToBounds(i,e),this}resetZoom(e=this.getViewportScreenCenter(),t){let{isLocked:i,constraints:s}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:r,y:n,z:a}=this.getCamera(),{x:h,y:o}=e,p=1;if(s){let e=this.getInitialZoom();a!==e&&(p=e)}return this.setCamera(new y.l(r+(h/p-h)-(h/a-h),n+(o/p-o)-(o/a-o),p),t),this}zoomIn(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{x:s,y:r,z:n}=this.getCamera(),{zoomSteps:h}=this.getCameraOptions();if(null!==h&&h.length>1){let i=this.getBaseZoom(),o=(0,a.HV)(h)*i;for(let e=1;e<h.length;e++){let t=h[e-1]*i,s=h[e]*i;if(!(s-n<=(s-t)/2)){o=s;break}}this.setCamera(new y.l(s+(e.x/o-e.x)-(e.x/n-e.x),r+(e.y/o-e.y)-(e.y/n-e.y),o),t)}return this}zoomOut(e=this.getViewportScreenCenter(),t){let{isLocked:i}=this.getCameraOptions();if(i&&!t?.force)return this;let{zoomSteps:s}=this.getCameraOptions();if(null!==s&&s.length>1){let i=this.getBaseZoom(),{x:r,y:n,z:a}=this.getCamera(),h=s[0]*i;for(let e=s.length-1;e>0;e--){let t=s[e-1]*i,r=s[e]*i;if(!(r-a>=(r-t)/2)){h=t;break}}this.setCamera(new y.l(r+(e.x/h-e.x)-(e.x/a-e.x),n+(e.y/h-e.y)-(e.y/a-e.y),h),t)}return this}zoomToSelection(e){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force)return this;let i=this.getSelectionPageBounds();return i&&this.zoomToBounds(i,{targetZoom:Math.max(1,this.getZoomLevel()),...e}),this}zoomToBounds(e,t){let i=this._cameraOptions.__unsafe__getWithoutCapture();if(i.isLocked&&!t?.force)return this;let s=this.getViewportScreenBounds(),r=t?.inset??Math.min(c.Up,.28*s.width),n=this.getBaseZoom(),h=i.zoomSteps[0],o=(0,a.HV)(i.zoomSteps),p=(0,w.qE)(Math.min((s.width-r)/e.w,(s.height-r)/e.h),h*n,o*n);return t?.targetZoom!==void 0&&(p=Math.min(t.targetZoom,p)),this.setCamera(new y.l(-e.x+(s.width-e.w*p)/2/p,-e.y+(s.height-e.h*p)/2/p,p),t),this}stopCameraAnimation(){return this.emit("stop-camera-animation"),this}_viewportAnimation=null;_animateViewport(e){if(!this._viewportAnimation)return;this._viewportAnimation.elapsed+=e;let{elapsed:t,easing:i,duration:s,start:r,end:n}=this._viewportAnimation;if(t>s){this.off("tick",this._animateViewport),this._viewportAnimation=null,this._setCamera(new y.l(-n.x,-n.y,this.getViewportScreenBounds().width/n.width));return}let a=i(1-(s-t)/s),h=r.minX+(n.minX-r.minX)*a,o=r.minY+(n.minY-r.minY)*a,p=r.maxX+(n.maxX-r.maxX)*a;this._setCamera(new y.l(-h,-o,this.getViewportScreenBounds().width/(p-h)),{force:!0})}_animateToViewport(e,t={animation:c.mp}){let{animation:i,...s}=t;if(!i)return;let{duration:r=0,easing:n=I.Z.easeInOutCubic}=i,a=this.user.getAnimationSpeed(),h=this.getViewportPageBounds();return(this.stopCameraAnimation(),this.getInstanceState().followingUserId&&this.stopFollowingUser(),0===r||0===a)?this._setCamera(new y.l(-e.x,-e.y,this.getViewportScreenBounds().width/e.width),{...s}):(this._viewportAnimation={elapsed:0,duration:r/a,easing:n,start:h.clone(),end:e.clone()},this.once("stop-camera-animation",()=>{this.off("tick",this._animateViewport),this._viewportAnimation=null}),this.on("tick",this._animateViewport),this)}slideCamera(e={}){let{isLocked:t}=this.getCameraOptions();if(t&&!e?.force||0===this.user.getAnimationSpeed())return this;this.stopCameraAnimation();let{speed:i,friction:s=this.options.cameraSlideFriction,direction:r,speedThreshold:n=.01}=e,a=Math.min(i,1),h=()=>{this.off("tick",o),this.off("stop-camera-animation",h)};this.once("stop-camera-animation",h);let o=e=>{let{x:t,y:i,z:o}=this.getCamera(),p=y.l.Mul(r,a*e/o);(a*=1-s)<n?h():this._setCamera(new y.l(t+p.x,i+p.y,o))};return this.on("tick",o),this}zoomToUser(e,t={animation:{duration:500}}){let i=this.getCollaborators().find(t=>t.userId===e);return i&&this.run(()=>{null!==this.getInstanceState().followingUserId&&this.stopFollowingUser();let s=i.currentPageId===this.getCurrentPageId();s||this.setCurrentPage(i.currentPageId),t&&t.animation&&!s&&(t.animation=void 0),this.centerOnPoint(i.cursor,t);let{highlightedUserIds:r}=this.getInstanceState();this.updateInstanceState({highlightedUserIds:[...r,e]}),this.timers.setTimeout(()=>{let t=[...this.getInstanceState().highlightedUserIds],i=t.indexOf(e);i<0||(t.splice(i,1),this.updateInstanceState({highlightedUserIds:t}))},this.options.collaboratorIdleTimeoutMs)}),this}_willSetInitialBounds=!0;updateViewportScreenBounds(e,t=!1){e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);let i=[0!==e.minY,!(0,w.YY)(document.body.scrollWidth,e.maxX,1),!(0,w.YY)(document.body.scrollHeight,e.maxY,1),0!==e.minX],{screenBounds:s,insets:r}=this.getInstanceState();if(e.equals(s)&&i.every((e,t)=>e===r[t]))return this;let{_willSetInitialBounds:n}=this;if(this._willSetInitialBounds=!1,n)this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.setCamera(this.getCamera());else if(t&&!this.getInstanceState().followingUserId){let t=this.getViewportPageBounds().center;this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this.centerOnPoint(t)}else this.updateInstanceState({screenBounds:e.toJson(),insets:i}),this._setCamera(y.l.From({...this.getCamera()}));return this._tickCameraState(),this}getViewportScreenBounds(){let{x:e,y:t,w:i,h:s}=this.getInstanceState().screenBounds;return new f.az(e,t,i,s)}getViewportScreenCenter(){let e=this.getViewportScreenBounds();return new y.l(e.midX-e.minX,e.midY-e.minY)}getViewportPageBounds(){let{w:e,h:t}=this.getViewportScreenBounds(),{x:i,y:s,z:r}=this.getCamera();return new f.az(-i,-s,e/r,t/r)}screenToPage(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(n.O9),{x:i,y:s,z:r=1}=this.getCamera();return new y.l((e.x-t.x)/r-i,(e.y-t.y)/r-s,e.z??.5)}pageToScreen(e){let{screenBounds:t}=this.store.unsafeGetWithoutCapture(n.O9),{x:i,y:s,z:r=1}=this.getCamera();return new y.l((e.x+i)*r+t.x,(e.y+s)*r+t.y,e.z??.5)}pageToViewport(e){let{x:t,y:i,z:s=1}=this.getCamera();return new y.l((e.x+t)*s,(e.y+i)*s,e.z??.5)}_getCollaboratorsQuery(){return this.store.query.records("instance_presence",()=>({userId:{neq:this.user.getId()}}))}getCollaborators(){let e=this._getCollaboratorsQuery().get();return e.length?[...new Set(e.map(e=>e.userId))].sort().map(t=>e.filter(e=>e.userId===t).sort((e,t)=>t.lastActivityTimestamp-e.lastActivityTimestamp)[0]):s.Ml}getCollaboratorsOnCurrentPage(){let e=this.getCurrentPageId();return this.getCollaborators().filter(t=>t.currentPageId===e)}_isLockedOnFollowingUser=(0,s.eU)("isLockedOnFollowingUser",!1);startFollowingUser(e){this.stopFollowingUser();let t=this._getCollaboratorsQuery().get().filter(t=>t.userId===e);if(!t.length)return console.warn("User not found"),this;let i=this.user.getId();if(i||console.warn("You should set the userId for the current instance before following a user"),t.some(e=>e.followingUserId===i))return this;let r=(0,s.EW)("latestLeaderPresence",()=>this.getCollaborators().find(t=>t.userId===e));return(0,s.hL)(()=>{this.updateInstanceState({followingUserId:e},{history:"ignore"});let t=(0,s.wv)("update current page",()=>{let e=r.get();if(!e){this.stopFollowingUser();return}e.currentPageId!==this.getCurrentPageId()&&this.getPage(e.currentPageId)&&this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:e.currentPageId}]),this._isLockedOnFollowingUser.set(!0)},{history:"ignore"})}),i=()=>{t(),this._isLockedOnFollowingUser.set(!1),this.off("frame",n),this.off("stop-following",i)},n=()=>{if(!r.get()){this.stopFollowingUser();return}if(this._isLockedOnFollowingUser.get())return;let e=this.user.getAnimationSpeed();if(0===e){this._isLockedOnFollowingUser.set(!0);return}let t=this.getViewportPageBoundsForFollowing();if(!t){this.stopFollowingUser();return}let i=this.getViewportPageBounds(),s=Math.abs(t.minX-i.minX)+Math.abs(t.maxX-i.maxX),n=Math.abs(t.minY-i.minY)+Math.abs(t.maxY-i.maxY);if(s<this.options.followChaseViewportSnap&&n<this.options.followChaseViewportSnap){this._isLockedOnFollowingUser.set(!0);return}let h=(0,w.qE)(.5*e,.1,.8),o=new f.az((0,a.Cc)(i.minX,t.minX,h),(0,a.Cc)(i.minY,t.minY,h),(0,a.Cc)(i.width,t.width,h),(0,a.Cc)(i.height,t.height,h)),p=new y.l(-o.x,-o.y,this.getViewportScreenBounds().width/o.width);this.stopCameraAnimation(),this._setCamera(p)};this.once("stop-following",i),this.addListener("frame",n),n()}),this}stopFollowingUser(){return this.run(()=>{this.store.put([this.getCamera()]),this._isLockedOnFollowingUser.set(!1),this.updateInstanceState({followingUserId:null}),this.emit("stop-following")},{history:"ignore"}),this}getUnorderedRenderingShapes(e){let t=[],i=2*this.options.maxShapesPerPage,s=this.options.maxShapesPerPage,r=this.getErasingShapeIds(),n=(a,h,o)=>{let p=this.getShape(a);if(!p)return;h*=p.opacity;let l=!1,g=this.getShapeUtil(p);e&&(l=!o&&r.includes(a))&&(h*=.32),t.push({id:a,shape:p,util:g,index:i,backgroundIndex:s,opacity:h}),i+=1,s+=1;let d=this.getSortedChildIdsForParent(a);if(!d.length)return;let u=null;for(let e of(g.providesBackgroundForChildren(p)&&(u=s,s=i,i+=this.options.maxShapesPerPage),d))n(e,h,o||l);null!==u&&(s=u)};for(let t of e?[this.getCurrentPage()]:this.getPages())for(let e of this.getSortedChildIdsForParent(t.id))n(e,1,!1);return t}_cameraState=(0,s.eU)("camera state","idle");_cameraStateTimeoutRemaining=0;_decayCameraStateTimeout=e=>{this._cameraStateTimeoutRemaining-=e,this._cameraStateTimeoutRemaining>0||(this.off("tick",this._decayCameraStateTimeout),this._cameraState.set("idle"))};_tickCameraState=()=>{this._cameraStateTimeoutRemaining=this.options.cameraMovingTimeoutMs,"idle"===this._cameraState.__unsafe__getWithoutCapture()&&(this._cameraState.set("moving"),this.on("tick",this._decayCameraStateTimeout))};getCameraState(){return this._cameraState.get()}getRenderingShapes(){return this.getUnorderedRenderingShapes(!0).sort(a.rb)}_getAllPagesQuery(){return this.store.query.records("page")}getPages(){return this._getAllPagesQuery().get().sort(a.Ky)}getCurrentPage(){return this.getPage(this.getCurrentPageId())}getCurrentPageId(){return this.getInstanceState().currentPageId}getPage(e){return this.store.get("string"==typeof e?e:e.id)}_currentPageShapeIds;getCurrentPageShapeIds(){return this._currentPageShapeIds.get()}getCurrentPageShapeIdsSorted(){return Array.from(this.getCurrentPageShapeIds()).sort()}getPageShapeIds(e){let t="string"==typeof e?e:e.id,i=this.store.query.exec("shape",{parentId:{eq:t}});return this.getShapeAndDescendantIds(i.map(e=>e.id))}setCurrentPage(e){let t="string"==typeof e?e:e.id;return this.store.has(t)?(this.stopFollowingUser(),this.complete(),this.run(()=>{this.store.put([{...this.getInstanceState(),currentPageId:t}])},{history:"record-preserveRedoStack"})):(console.error("Tried to set the current page id to a page that doesn't exist."),this)}updatePage(e){return this.getInstanceState().isReadonly||!this.getPage(e.id)?this:this.run(()=>this.store.update(e.id,t=>({...t,...e})))}createPage(e){return this.run(()=>{if(this.getInstanceState().isReadonly||this.getPages().length>=this.options.maxPages)return;let t=this.getPages(),i=(0,b.g)(e.name??"Page 1",t.map(e=>e.name)),s=e.index;(!s||t.some(e=>e.index===s))&&(s=(0,a.AQ)(t[t.length-1].index));let r=n.tv.create({meta:{},...e,name:i,index:s});this.store.put([r])}),this}deletePage(e){let t="string"==typeof e?e:e.id;return this.run(()=>{if(this.getInstanceState().isReadonly)return;let e=this.getPages();if(1===e.length)return;let i=this.getPage(t);if(i){if(t===this.getCurrentPageId()){let i=e.findIndex(e=>e.id===t),s=e[i-1]??e[i+1];this.setCurrentPage(s.id)}this.store.remove([i.id])}}),this}duplicatePage(e,t=n.tv.createId()){if(this.getPages().length>=this.options.maxPages)return this;let i="string"==typeof e?e:e.id,s=this.getPage(i);if(!s)return this;let r={...this.getCamera()},h=this.getContentFromCurrentPage(this.getSortedChildIdsForParent(s.id));return this.run(()=>{let e=this.getPages(),i=(0,a.HE)(s.index,e[e.indexOf(s)+1]?.index);if(this.createPage({name:s.name+" Copy",id:t,index:i}),this.setCurrentPage(t),this.setCamera(r),h)return this.putContentOntoCurrentPage(h)}),this}renamePage(e,t){let i="string"==typeof e?e:e.id;return this.getInstanceState().isReadonly||this.updatePage({id:i,name:t}),this}_getAllAssetsQuery(){return this.store.query.records("asset")}getAssets(){return this._getAllAssetsQuery().get()}createAssets(e){return this.getInstanceState().isReadonly||e.length<=0||this.run(()=>this.store.put(e),{history:"ignore"}),this}updateAssets(e){return this.getInstanceState().isReadonly||e.length<=0||this.run(()=>{this.store.put(e.map(e=>({...this.store.get(e.id),...e})))},{history:"ignore"}),this}deleteAssets(e){if(this.getInstanceState().isReadonly)return this;let t="string"==typeof e[0]?e:e.map(e=>e.id);return t.length<=0||this.run(()=>this.store.remove(t),{history:"ignore"}),this}getAsset(e){return this.store.get("string"==typeof e?e:e.id)}async resolveAssetUrl(e,t){if(!e)return null;let i=this.getAsset(e);if(!i)return null;let{screenScale:s=1,shouldResolveToOriginal:r=!1}=t,n=Math.max(.125,Math.pow(2,Math.ceil(Math.log2(s)))),a="connection"in navigator?navigator.connection.effectiveType:null,h=this.getInstanceState().devicePixelRatio;return await this.store.props.assets.resolve(i,{screenScale:s||1,steppedScreenScale:n,dpr:h,networkEffectiveType:a,shouldResolveToOriginal:r})}async uploadAsset(e,t){return await this.store.props.assets.upload(e,t)}_getShapeGeometryCache(){return this.store.createComputedCache("bounds",e=>this.getShapeUtil(e).getGeometry(e),(e,t)=>e.props===t.props)}getShapeGeometry(e){return this._getShapeGeometryCache().get("string"==typeof e?e:e.id)}_getShapeHandlesCache(){return this.store.createComputedCache("handles",e=>this.getShapeUtil(e).getHandles?.(e))}getShapeHandles(e){return this._getShapeHandlesCache().get("string"==typeof e?e:e.id)}getShapeLocalTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);if(!i)throw Error("Editor.getTransform: shape not found");return m.V.Identity().translate(i.x,i.y).rotate(i.rotation)}_getShapePageTransformCache(){return this.store.createComputedCache("pageTransformCache",e=>{if((0,n.xh)(e.parentId))return this.getShapeLocalTransform(e);let t=this._getShapePageTransformCache().get(e.parentId)??m.V.Identity();return m.V.Compose(t,this.getShapeLocalTransform(e))})}getShapeParentTransform(e){let t="string"==typeof e?e:e.id,i=this.getShape(t);return!i||(0,n.xh)(i.parentId)?m.V.Identity():this._getShapePageTransformCache().get(i.parentId)??m.V.Identity()}getShapePageTransform(e){let t="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(t)??m.V.Identity()}_getShapePageBoundsCache(){return this.store.createComputedCache("pageBoundsCache",e=>{let t=this._getShapePageTransformCache().get(e.id);return t?f.az.FromPoints(m.V.applyToPoints(t,this.getShapeGeometry(e).vertices)):new f.az})}getShapePageBounds(e){return this._getShapePageBoundsCache().get("string"==typeof e?e:e.id)}_getShapeClipPathCache(){return this.store.createComputedCache("clipPathCache",e=>{let t=this._getShapeMaskCache().get(e.id);if(!t)return;if(0===t.length)return"polygon(0px 0px, 0px 0px, 0px 0px)";let i=this._getShapePageTransformCache().get(e.id);if(!i)return;let s=m.V.applyToPoints(m.V.Inverse(i),t);return`polygon(${s.map(e=>`${e.x}px ${e.y}px`).join(",")})`})}getShapeClipPath(e){return this._getShapeClipPathCache().get("string"==typeof e?e:e.id)}_getShapeMaskCache(){return this.store.createComputedCache("pageMaskCache",e=>{if((0,n.xh)(e.parentId))return;let t=this.getShapeAncestors(e.id).filter(e=>this.isShapeOfType(e,"frame"));if(0!==t.length)return t.map(e=>this._getShapePageTransformCache().get(e.id).applyToPoints(this.getShapeGeometry(e).vertices)).reduce((e,t)=>{if(!(t&&e))return;let i=(0,C.oQ)(e,t);return i?i.map(y.l.Cast):[]})})}getShapeMask(e){return this._getShapeMaskCache().get("string"==typeof e?e:e.id)}getShapeMaskedPageBounds(e){return"string"!=typeof e&&(e=e.id),this._getShapeMaskedPageBoundsCache().get(e)}_getShapeMaskedPageBoundsCache(){return this.store.createComputedCache("shapeMaskedPageBoundsCache",e=>{let t=this._getShapePageBoundsCache().get(e.id);if(!t)return;let i=this._getShapeMaskCache().get(e.id);if(i){if(0===i.length)return;let{corners:e}=t;if(e.every((e,t)=>e&&y.l.Equals(e,i[t])))return t.clone();let s=(0,C.oQ)(i,e);if(!s)return;return f.az.FromPoints(s)}return t})}getShapeAncestors(e,t=[]){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return t;let r=s.parentId;if((0,n.xh)(r))return t.reverse(),t;let a=this.store.get(r);return a?(t.push(a),this.getShapeAncestors(a,t)):t}findShapeAncestor(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return;let r=s.parentId;if((0,n.xh)(r))return;let a=this.getShape(r);if(a)return t(a)?a:this.findShapeAncestor(a,t)}hasAncestor(e,t){let i="string"==typeof e?e:e?.id,s=i&&this.getShape(i);return!!s&&(s.parentId===t||this.hasAncestor(this.getShapeParent(s),t))}findCommonAncestor(e,t){if(0===e.length)return;let i="string"==typeof e[0]?e:e.map(e=>e.id),s=(0,a.oE)(i.map(e=>this.getShape(e)));if(1===s.length){let e=s[0].parentId;if((0,n.xh)(e))return;return t?this.findShapeAncestor(s[0],t)?.id:e}let[r,...h]=s,o=this.getShapeParent(r);for(;o;){if(t&&!t(o)){o=this.getShapeParent(o);continue}if(h.every(e=>this.hasAncestor(e,o.id)))return o.id;o=this.getShapeParent(o)}}isShapeOrAncestorLocked(e){let t="string"==typeof e?this.getShape(e):e;return void 0!==t&&(!!t.isLocked||this.isShapeOrAncestorLocked(this.getShapeParent(t)))}_notVisibleShapes(){return(0,A.s)(this)}getCulledShapes(){let e=this._notVisibleShapes().get(),t=this.getSelectedShapeIds(),i=this.getEditingShapeId(),s=new Set(e);return i&&s.delete(i),t.forEach(e=>{s.delete(e)}),s}getCurrentPageBounds(){let e;return this.getCurrentPageShapeIdsSorted().forEach(t=>{let i=this.getShapeMaskedPageBounds(t);i&&(e=e?e.expand(i):i.clone())}),e}getSelectedShapeAtPoint(e){let t=this.getSelectedShapeIds();return this.getCurrentPageShapesSorted().filter(e=>"group"!==e.type&&t.includes(e.id)).reverse().find(t=>this.isPointInShape(t,e,{hitInside:!0,margin:0}))}getShapeAtPoint(e,t={}){let i=this.getZoomLevel(),s=this.getViewportPageBounds(),{filter:r,margin:n=0,hitLocked:a=!1,hitLabels:h=!1,hitInside:o=!1,hitFrameInside:p=!1}=t,l=1/0,g=null,d=1/0,u=null,c=(t.renderingOnly?this.getCurrentPageRenderingShapesSorted():this.getCurrentPageShapesSorted()).filter(t=>{if(t.isLocked&&!a||this.isShapeOfType(t,"group"))return!1;let i=this.getShapeMask(t);return(!i||!!(0,w.s3)(e,i))&&(!r||r(t))});for(let t=c.length-1;t>=0;t--){let r;let a=c[t],S=this.getShapeGeometry(a),f=S instanceof P.I,m=this.getPointInShapeSpace(a,e);if((this.isShapeOfType(a,"arrow")||this.isShapeOfType(a,"geo")&&"none"===a.props.fill)&&a.props.text.trim()){for(let e of S.children)if(e.isLabel&&e.isPointInBounds(m))return a}if(this.isShapeOfType(a,"frame")){if(Math.abs(S.distanceToPoint(m,o))<=n)return u||a;if(S.hitTestPoint(m,0,!0))return u||g||(p?a:void 0);continue}if(f){let e=1/0;for(let t of S.children){if(t.isLabel&&!h)continue;let i=t.distanceToPoint(m,o);i<e&&(e=i)}r=e}else r=0===n&&(S.bounds.w<1||S.bounds.h<1)?S.distanceToPoint(m,o):S.bounds.containsPoint(m,n)?S.distanceToPoint(m,o):1/0;if(S.isClosed){if(r<=n){if(S.isFilled||f&&S.children[0].isFilled)return u||a;if(this.getShapePageBounds(a).contains(s))continue;if(Math.abs(r)<n)Math.abs(r)<d&&(d=Math.abs(r),u=a);else if(!u){let{area:e}=S;e<l&&(l=e,g=a)}}}else if(r<this.options.hitTestMargin/i)return a}return u||g||void 0}getShapesAtPoint(e,t={}){return this.getCurrentPageShapes().filter(i=>this.isPointInShape(i,e,t))}isPointInShape(e,t,i={}){let{hitInside:s=!1,margin:r=0}=i,n="string"==typeof e?e:e.id,a=this.getShapeMask(n);return(!a||!!(0,w.s3)(t,a))&&this.getShapeGeometry(n).hitTestPoint(this.getPointInShapeSpace(e,t),r,s)}getPointInShapeSpace(e,t){let i="string"==typeof e?e:e.id;return this._getShapePageTransformCache().get(i).clone().invert().applyToPoint(t)}getPointInParentSpace(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return new y.l(0,0);if((0,n.xh)(s.parentId))return y.l.From(t);let r=this.getShapePageTransform(s.parentId);return r?r.clone().invert().applyToPoint(t):y.l.From(t)}getCurrentPageShapes(){return Array.from(this.getCurrentPageShapeIds(),e=>this.store.get(e))}getCurrentPageShapesSorted(){let e=[],t=this.getSortedChildIdsForParent(this.getCurrentPageId());for(let i=0,s=t.length;i<s;i++)!function e(t,i,s){let r=t.getShape(i);if(!r)return;s.push(r);let n=t.getSortedChildIdsForParent(i);for(let i=0,r=n.length;i<r;i++)e(t,n[i],s)}(this,t[i],e);return e}getCurrentPageRenderingShapesSorted(){let e=this.getCulledShapes();return this.getCurrentPageShapesSorted().filter(({id:t})=>!e.has(t))}isShapeOfType(e,t){let i="string"==typeof e?this.getShape(e):e;return!!i&&i.type===t}getShape(e){let t="string"==typeof e?e:e.id;if((0,n.vc)(t))return this.store.get(t)}getShapeParent(e){let t="string"==typeof e?e:e?.id;if(!t)return;let i=this.getShape(t);if(void 0!==i&&(0,n.vc)(i.parentId))return this.store.get(i.parentId)}getShapeNearestSibling(e,t){return t?t.parentId===e.parentId?t:this.findShapeAncestor(t,t=>t.parentId===e.parentId):void 0}isShapeInPage(e,t=this.getCurrentPageId()){let i="string"==typeof e?e:e.id,s=this.getShape(i);if(!s)return!1;let r=!1;if(s.parentId===t)r=!0;else{let e=this.getShape(s.parentId);for(;e;){if(e.parentId===t){r=!0;break}e=this.getShape(e.parentId)}}return r}getAncestorPageId(e){let t="string"==typeof e?e:e?.id,i=t&&this.getShape(t);if(i)return(0,n.xh)(i.parentId)?i.parentId:this.getAncestorPageId(this.getShape(i.parentId))}_parentIdsToChildIds;reparentShapes(e,t,i){let s="string"==typeof e[0]?e:e.map(e=>e.id);if(0===s.length)return this;let r=[],h=(0,n.xh)(t)?m.V.Identity():this.getShapePageTransform(t),o=h.rotation(),p=[],l=(0,a.oE)(this.getSortedChildIdsForParent(t).map(e=>this.getShape(e)));if(i){let e=l.find(e=>e.index===i);if(e){let t=l[l.indexOf(e)+1];p=t?(0,a.MT)(i,t.index,s.length):(0,a.Zo)(i,s.length)}else{let e=l.sort(a.Ky).find(e=>e.index>i);p=e?(0,a.MT)(i,e.index,s.length):(0,a.Zo)(i,s.length)}}else{let e=l.length&&l[l.length-1];p=e?(0,a.Zo)(e.index,s.length):(0,a.uu)(s.length)}let g=h.clone().invert(),d=(0,a.oE)(s.map(e=>this.getShape(e)));return this.run(()=>{for(let e=0;e<d.length;e++){let i=d[e],s=this.getShapePageTransform(i);if(!s)continue;let n=s.point();if(!n)continue;let a=g.applyToPoint(n),h=s.rotation()-o;r.push({id:i.id,type:i.type,parentId:t,x:a.x,y:a.y,rotation:h,index:p[e]})}this.updateShapes(r)},{ignoreShapeLock:!0}),this}getHighestIndexForParent(e){let t="string"==typeof e?e:e.id,i=this._parentIdsToChildIds.get()[t];if(!i||0===i.length)return"a1";let s=this.getShape(i[i.length-1]);return(0,a.AQ)(s.index)}getSortedChildIdsForParent(e){let t="string"==typeof e?e:e.id;return this._parentIdsToChildIds.get()[t]||s.Ml}visitDescendants(e,t){let i="string"==typeof e?e:e.id;for(let e of this.getSortedChildIdsForParent(i))!1!==t(e)&&this.visitDescendants(e,t);return this}getShapeAndDescendantIds(e){let t=new Set;for(let i of e.map(e=>this.getShape(e)).sort(a.Ky))t.add(i.id),this.visitDescendants(i,e=>{t.add(e)});return t}getDroppingOverShape(e,t=[]){let i=this.getCurrentPageShapesSorted();for(let s=i.length-1;s>=0;s--){let r=i[s];if(this.getSelectedShapeIds().includes(r.id)||!this.getShapeUtil(r).canDropShapes(r,t)||t.find(e=>e.id===r.id||this.hasAncestor(r,e.id)))continue;let n=this.getShapeMaskedPageBounds(r.id);if(n&&n.containsPoint(e)&&this.getShapeGeometry(r).hitTestPoint(this.getPointInShapeSpace(r,e),0,!0))return r}}getOutermostSelectableShape(e,t){let i="string"==typeof e?e:e.id,s=this.getShape(i),r=s,n=s,a=this.getFocusedGroup();for(;n;){if(this.isShapeOfType(n,"group")&&a?.id!==n.id&&!this.hasAncestor(a,n.id)&&(t?.(n)??!0))r=n;else if(a?.id===n.id)break;n=this.getShapeParent(n)}return r}_getBindingsIndexCache(){let e=(0,B.V)(this);return this.store.createComputedCache("bindingsIndex",t=>e.get().get(t.id))}getBinding(e){return this.store.get(e)}getBindingsFromShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.fromId===i&&e.type===t)}getBindingsToShape(e,t){let i="string"==typeof e?e:e.id;return this.getBindingsInvolvingShape(i).filter(e=>e.toId===i&&e.type===t)}getBindingsInvolvingShape(e,t){let i="string"==typeof e?e:e.id,r=this._getBindingsIndexCache().get(i)??s.Ml;return t?r.filter(e=>e.type===t):r}createBindings(e){let t=[];for(let i of e){let e=this.getShape(i.fromId),s=this.getShape(i.toId);if(!e||!s||!this.canBindShapes({fromShape:e,toShape:s,binding:i}))continue;let r=this.getBindingUtil(i.type).getDefaultProps(),a=this.store.schema.types.binding.create({...i,id:i.id??(0,n.BN)(),props:{...r,...i.props}});t.push(a)}return this.store.put(t),this}createBinding(e){return this.createBindings([e])}updateBindings(e){let t=[];for(let i of e){if(!i)continue;let e=this.getBinding(i.id);if(!e)continue;let s=Q(e,i);if(s===e)continue;let r=this.getShape(s.fromId),n=this.getShape(s.toId);r&&n&&this.canBindShapes({fromShape:r,toShape:n,binding:s})&&t.push(s)}return this.store.put(t),this}updateBinding(e){return this.updateBindings([e])}deleteBindings(e,{isolateShapes:t=!1}={}){let i=e.map(e=>"string"==typeof e?e:e.id);return t?this.store.atomic(()=>{for(let e of i){let t=this.getBinding(e);if(!t)continue;let i=this.getBindingUtil(t);i.onBeforeIsolateFromShape?.({binding:t,removedShape:this.getShape(t.toId)}),i.onBeforeIsolateToShape?.({binding:t,removedShape:this.getShape(t.fromId)}),this.store.remove([e])}}):this.store.remove(i),this}deleteBinding(e,t){return this.deleteBindings([e],t)}canBindShapes({fromShape:e,toShape:t,binding:i}){let s="string"==typeof e?e:e.type,r="string"==typeof t?t:t.type,n={fromShapeType:s,toShapeType:r,bindingType:"string"==typeof i?i:i.type};return s===r?this.getShapeUtil(s).canBind(n):this.getShapeUtil(s).canBind(n)&&this.getShapeUtil(r).canBind(n)}rotateShapesBy(e,t){if(("string"==typeof e[0]?e:e.map(e=>e.id)).length<=0)return this;let i=(0,v.f)({editor:this});return i&&(0,v._)({delta:t,snapshot:i,editor:this,stage:"one-off"}),this}getChangesToTranslateShape(e,t){let i=e,s=this.getShapeUtil(e);return i=Q(i,s.onTranslateStart?.(i)??void 0),i=Q(i,{id:e.id,type:e.type,x:t.x,y:t.y}),i=Q(i,s.onTranslate?.(e,i)??void 0),i=Q(i,s.onTranslateEnd?.(e,i)??void 0)}nudgeShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=[];for(let e of i){let i=this.getShape(e),r=y.l.From(t),n=this.getShapeParentTransform(i);n&&r.rot(-n.rotation()),s.push(this.getChangesToTranslateShape(i,r.add(i)))}return this.updateShapes(s),this}duplicateShapes(e,t){return this.run(()=>{let i="string"==typeof e[0]?e:e.map(e=>e.id);if(i.length<=0)return this;let s=new Set(i),r=this.getShapeAndDescendantIds(i),h=[...r].reverse(),o=new Map;for(let e of r)o.set(e,(0,n.n6)());let{shapesToCreate:p,bindingsToCreate:l}=$(this,r,e=>{let i=[];for(let t of e){let e=this.getBinding(t);if(!e)continue;let s=(0,n.BN)();i.push({...e,id:s,fromId:(0,a.Z1)(o.get(e.fromId)),toId:(0,a.Z1)(o.get(e.toId))})}let r=[];for(let e of h){let i=(0,a.Z1)(o.get(e)),n=this.getShape(e);if(!n)continue;let h=0,p=0;if(t&&s.has(e)){let e=this.getShapeParentTransform(n),i=new y.l(t.x,t.y).rot(-e.rotation());h=i.x,p=i.y}let l=n.parentId,g=this.getSortedChildIdsForParent(l),d=g.indexOf(n.id),u=g[d+1],c=u?this.getShape(u):null,S=c?(0,a.HE)(n.index,c.index):(0,a.AQ)(n.index);r.push({...n,id:i,x:n.x+h,y:n.y+p,index:S,parentId:o.get(n.parentId)??n.parentId})}return{shapesToCreate:r,bindingsToCreate:i}});if(p.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage){j(this);return}if(this.createShapes(p),this.createBindings(l),this.setSelectedShapes((0,a.oE)(i.map(e=>o.get(e)))),void 0!==t){let e=this.getSelectionPageBounds(),t=this.getViewportPageBounds();e&&!t.contains(e)&&this.centerOnPoint(e.center,{animation:{duration:this.options.animationMediumMs}})}}),this}moveShapesToPage(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(0===i.length||this.getInstanceState().isReadonly||t===this.getCurrentPageId()||!this.store.has(t))return this;let s=this.getContentFromCurrentPage(i);if(!s)return this;if(this.getPageShapeIds(t).size+s.shapes.length>this.options.maxShapesPerPage)return j(this,t),this;let r=this.getCamera().z;return this.run(()=>{this.deleteShapes(i),this.setCurrentPage(t),this.setFocusedGroup(null),this.selectNone(),this.putContentOntoCurrentPage(s,{select:!0,preserveIds:!0,preservePosition:!0}),this.setCamera({...this.getCamera(),z:r}),this.centerOnPoint(this.getSelectionRotatedPageBounds().center)}),this}toggleLock(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||0===t.length)return this;let i=!0,s=!0,r=[];for(let e of t){let t=this.getShape(e);t&&(r.push(t),t.isLocked?s=!1:i=!1)}return this.run(()=>{s?(this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0}))),this.setSelectedShapes([])):i?this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!1}))):this.updateShapes(r.map(e=>({id:e.id,type:e.type,isLocked:!0})))}),this}sendToBack(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,E.T)(this,"toBack",t);return i&&this.updateShapes(i),this}sendBackward(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,E.T)(this,"backward",t);return i&&this.updateShapes(i),this}bringForward(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,E.T)(this,"forward",t);return i&&this.updateShapes(i),this}bringToFront(e){let t="string"==typeof e[0]?e:e.map(e=>e.id),i=(0,E.T)(this,"toFront",t);return i&&this.updateShapes(i),this}flipShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly)return this;let s=(0,a.oE)(i.map(e=>this.getShape(e)));if(!s.length)return this;s=(0,a.oE)(s.map(e=>this.isShapeOfType(e,"group")?this.getSortedChildIdsForParent(e.id).map(e=>this.getShape(e)):e).flat());let r=f.az.Common((0,a.oE)(s.map(e=>this.getShapePageBounds(e)))).center;return this.run(()=>{for(let e of s){let i=this.getShapeGeometry(e).bounds,s=this.getShapePageTransform(e.id);s&&this.resizeShape(e.id,{x:"horizontal"===t?-1:1,y:"vertical"===t?-1:1},{initialBounds:i,initialPageTransform:s,initialShape:e,mode:"scale_shape",isAspectRatioLocked:this.getShapeUtil(e).isAspectRatioLocked(e),scaleOrigin:r,scaleAxisRotation:0})}}),this}stackShapes(e,t,i){let s,r,n,a,h;let o="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly)return this;let p=o.map(e=>this.getShape(e)).filter(e=>!!e&&this.getShapeUtil(e).canBeLaidOut(e)),l=p.length;if(0===i&&l<3||l<2)return this;let g=Object.fromEntries(p.map(e=>[e.id,this.getShapePageBounds(e)]));if("horizontal"===t?(s="x",r="minX",n="maxX",a="width"):(s="y",r="minY",n="maxY",a="height"),0===i){let e=[];p.sort((e,t)=>g[e.id][r]-g[t.id][r]);for(let t=0;t<l-1;t++){let i=p[t],s=p[t+1],a=g[i.id],h=g[s.id][r]-a[n],o=e.find(e=>e.gap===h);o?o.count++:e.push({gap:h,count:1})}let t=0;e.forEach(e=>{e.count>t&&(t=e.count,h=e.gap)}),1===t&&(h=Math.max(0,e.reduce((e,t)=>e+t.gap*t.count,0)/(l-1)))}else h=i;let d=[],u=g[p[0].id][n];return p.forEach((e,t)=>{if(0===t)return;let i={x:0,y:0};i[s]=u+h-g[e.id][s];let r=this.getShapeParent(e),n=r?y.l.Rot(i,-this.getShapePageTransform(r).decompose().rotation):i,o=this.getShapeUtil(e).onTranslateStart?.(e);d.push(o?{...o,[s]:e[s]+n[s]}:{id:e.id,type:e.type,[s]:e[s]+n[s]}),u+=g[e.id][a]+h}),this.updateShapes(d),this}packShapes(e,t){let i,s,r;let n="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||n.length<2)return this;let h=n.map(e=>this.getShape(e)).filter(e=>!!e&&this.getShapeUtil(e).canBeLaidOut(e)),o={},p={},l,g,d=0;for(let e=0;e<h.length;e++)l=h[e],g=this.getShapePageBounds(l),o[l.id]=g,p[l.id]=g.clone(),d+=g.width*g.height;let u=f.az.Common((0,a.oE)(Object.values(o))),c=u.width;h.sort((e,t)=>o[t.id].height-o[e.id].height);let S=Math.max(Math.ceil(Math.sqrt(d/.95)),c),m=[new f.az(u.x,u.y,S,1/0)],I=0,P=0;for(let e=0;e<h.length;e++){g=p[(l=h[e]).id];for(let e=m.length-1;e>=0;e--)if(i=m[e],!(g.width>i.width)&&!(g.height>i.height)){g.x=i.x,g.y=i.y,P=Math.max(P,g.maxY),I=Math.max(I,g.maxX),g.width===i.width&&g.height===i.height?(s=m.pop(),e<m.length&&(m[e]=s)):g.height===i.height?(i.x+=g.width+t,i.width-=g.width+t):(g.width===i.width||m.push(new f.az(i.x+(g.width+t),i.y,i.width-(g.width+t),g.height)),i.y+=g.height+t,i.height-=g.height+t);break}}let C=f.az.Common(Object.values(p)),w=y.l.Sub(u.center,C.center),_=[];for(let e=0;e<h.length;e++){g=o[(l=h[e]).id],r=p[l.id];let t=y.l.Sub(r.point,g.point).add(w),i=this.getShapeParentTransform(l);i&&t.rot(-i.rotation());let s={id:l.id,type:l.type,x:l.x+t.x,y:l.y+t.y},n=this.getShapeUtil(l).onTranslateStart?.({...l,...s});n?_.push({...s,...n}):_.push(s)}return _.length&&this.updateShapes(_),this}alignShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||i.length<2)return this;let s=(0,a.oE)(i.map(e=>this.getShape(e))),r=Object.fromEntries(s.map(e=>[e.id,this.getShapePageBounds(e)])),n=f.az.Common((0,a.oE)(Object.values(r))),h=[];return s.forEach(e=>{let i=r[e.id];if(!i)return;let s={x:0,y:0};switch(t){case"top":s.y=n.minY-i.minY;break;case"center-vertical":s.y=n.midY-i.minY-i.height/2;break;case"bottom":s.y=n.maxY-i.minY-i.height;break;case"left":s.x=n.minX-i.minX;break;case"center-horizontal":s.x=n.midX-i.minX-i.width/2;break;case"right":s.x=n.maxX-i.minX-i.width}let a=this.getShapeParent(e),o=a?y.l.Rot(s,-this.getShapePageTransform(a).decompose().rotation):s;h.push(this.getChangesToTranslateShape(e,y.l.Add(e,o)))}),this.updateShapes(h),this}distributeShapes(e,t){let i,s,r,n,h;let o="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||o.length<3)return this;let p=o.length,l=(0,a.oE)(o.map(e=>this.getShape(e))),g=Object.fromEntries(l.map(e=>[e.id,this.getShapePageBounds(e)]));"horizontal"===t?(i="x",s="minX",r="maxX",n="midX",h="width"):(i="y",s="minY",r="maxY",n="midY",h="height");let d=[],u=l.sort((e,t)=>g[e.id][s]-g[t.id][s])[0],c=l.sort((e,t)=>g[t.id][r]-g[e.id][r])[0],S=g[u.id][n],f=(g[c.id][n]-S)/(p-1),m=S+f;return l.filter(e=>e!==u&&e!==c).sort((e,t)=>g[e.id][n]-g[t.id][n]).forEach((e,t)=>{let s={x:0,y:0};s[i]=m+f*t-g[e.id][h]/2-g[e.id][i];let r=this.getShapeParent(e),n=r?y.l.Rot(s,-this.getShapePageTransform(r).rotation()):s;d.push(this.getChangesToTranslateShape(e,y.l.Add(e,n)))}),this.updateShapes(d),this}stretchShapes(e,t){let i="string"==typeof e[0]?e:e.map(e=>e.id);if(this.getInstanceState().isReadonly||i.length<2)return this;let s=(0,a.oE)(i.map(e=>this.getShape(e))),r=Object.fromEntries(i.map(e=>[e,this.getShapeGeometry(e).bounds])),n=Object.fromEntries(i.map(e=>[e,this.getShapePageBounds(e)])),h=f.az.Common((0,a.oE)(Object.values(n)));switch(t){case"vertical":this.run(()=>{for(let e of s){if(this.getShapePageTransform(e).rotation()%w.uA)continue;let t=r[e.id],i=n[e.id],s=new y.l(0,h.minY-i.minY),a=this.getShapeParentTransform(e);a&&s.rot(-a.rotation());let{x:o,y:p}=y.l.Add(s,e);this.updateShapes([{id:e.id,type:e.type,x:o,y:p}]);let l=new y.l(1,h.height/i.height);this.resizeShape(e.id,l,{initialBounds:t,scaleOrigin:new y.l(i.center.x,h.minY),isAspectRatioLocked:this.getShapeUtil(e).isAspectRatioLocked(e),scaleAxisRotation:0})}});break;case"horizontal":this.run(()=>{for(let e of s){let t=r[e.id],i=n[e.id];if(this.getShapePageTransform(e).rotation()%w.uA)continue;let s=new y.l(h.minX-i.minX,0),a=this.getShapeParentTransform(e);a&&s.rot(-a.rotation());let{x:o,y:p}=y.l.Add(s,e);this.updateShapes([{id:e.id,type:e.type,x:o,y:p}]);let l=new y.l(h.width/i.width,1);this.resizeShape(e.id,l,{initialBounds:t,scaleOrigin:new y.l(h.minX,i.center.y),isAspectRatioLocked:this.getShapeUtil(e).isAspectRatioLocked(e),scaleAxisRotation:0})}})}return this}resizeShape(e,t,i={}){let s="string"==typeof e?e:e.id;if(this.getInstanceState().isReadonly)return this;Number.isFinite(t.x)||(t=new y.l(1,t.y)),Number.isFinite(t.y)||(t=new y.l(t.x,1));let r=i.initialShape??this.getShape(s);if(!r)return this;let n=i.scaleOrigin??this.getShapePageBounds(s)?.center;if(!n)return this;let a=i.initialPageTransform?m.V.Cast(i.initialPageTransform):this.getShapePageTransform(s);if(!a)return this;let h=a.rotation();if(null==h)return this;let o=i.scaleAxisRotation??h,p=i.initialBounds??this.getShapeGeometry(s).bounds;if(!p)return this;let l=i.isAspectRatioLocked??this.getShapeUtil(r).isAspectRatioLocked(r);if(!(0,w.jw)(h,o))return this._resizeUnalignedShape(s,t,{...i,initialBounds:p,scaleOrigin:n,scaleAxisRotation:o,initialPageTransform:a,isAspectRatioLocked:l,initialShape:r});let g=this.getShapeUtil(r);if(l&&(t=Math.abs(t.x)>Math.abs(t.y)?new y.l(t.x,Math.sign(t.y)*Math.abs(t.x)):new y.l(Math.sign(t.x)*Math.abs(t.y),t.y)),g.onResize&&g.canResize(r)){let e=this._scalePagePoint(m.V.applyToPoint(a,new y.l(0,0)),n,t,o),l=this.getPointInParentSpace(r.id,e),d=new y.l(t.x,t.y),u=(0,w.YY)((h-o)%Math.PI,0);d.x=u?t.x:t.y,d.y=u?t.y:t.x;let c=m.V.applyToPoint(a,new y.l),{x:S,y:f}=this.getPointInParentSpace(r.id,c),I=r;i.skipStartAndEndCallbacks||(I=Q(r,g.onResizeStart?.(r)??void 0)),I=Q(I,{id:s,type:r.type,x:l.x,y:l.y,...g.onResize({...r,x:S,y:f},{newPoint:l,handle:i.dragHandle??"bottom_right",mode:i.mode??"scale_shape",scaleX:d.x,scaleY:d.y,initialBounds:p,initialShape:r})}),i.skipStartAndEndCallbacks||(I=Q(I,g.onResizeEnd?.(r,I)??void 0)),this.updateShapes([I])}else{let e=m.V.applyToPoint(a,p.center),i=this._scalePagePoint(e,n,t,o),h=this.getPointInParentSpace(r.id,e),l=this.getPointInParentSpace(r.id,i),g=y.l.Sub(l,h);this.updateShapes([{id:s,type:r.type,x:r.x+g.x,y:r.y+g.y}])}return this}_scalePagePoint(e,t,i,s){let r=y.l.RotWith(e,t,-s).sub(t),n=y.l.MulV(r,i);return y.l.Add(n,t).rotWith(t,s)}_resizeUnalignedShape(e,t,i){let{type:s}=i.initialShape,r=new y.l(t.x,t.y);if(Math.abs(t.x)>Math.abs(t.y)?r.x=Math.sign(t.x)*Math.abs(t.y):r.y=Math.sign(t.y)*Math.abs(t.x),this.resizeShape(e,r,{initialShape:i.initialShape,initialBounds:i.initialBounds,isAspectRatioLocked:i.isAspectRatioLocked}),Math.sign(t.x)*Math.sign(t.y)<0){let{rotation:t}=m.V.Decompose(i.initialPageTransform);t-=2*t,this.updateShapes([{id:e,type:s,rotation:t}])}let n=m.V.applyToPoint(i.initialPageTransform,i.initialBounds.center),a=this._scalePagePoint(n,i.scaleOrigin,t,i.scaleAxisRotation),h=this.getShapePageBounds(e),o=this.getShapePageTransform(e),p=h.center,l=o.point();if(!p||!l)return this;let g=y.l.Sub(a,p),d=y.l.Add(l,g),{x:u,y:c}=this.getPointInParentSpace(e,d);return this.updateShapes([{id:e,type:s,x:u,y:c}]),this}getInitialMetaForShape(e){return{}}createShape(e){return this.createShapes([e]),this}createShapes(e){if(!Array.isArray(e))throw Error("Editor.createShapes: must provide an array of shapes or shape partials");if(this.getInstanceState().isReadonly||e.length<=0)return this;let t=this.getCurrentPageShapeIds();if(e.length+t.size>this.options.maxShapesPerPage)return j(this),this;let i=this.getFocusedGroupId();return this.run(()=>{let t=this.getCurrentPageShapesSorted(),s=e.map(s=>{if(s.id||(s={id:(0,n.n6)(),...s}),!s.parentId||!(this.store.has(s.parentId)||e.some(e=>e.id===s.parentId))){let e=this.getFocusedGroupId();for(let i=t.length-1;i>=0;i--){let r=t[i];if(this.getShapeUtil(r).canReceiveNewChildrenOfType(r,s.type)&&this.isPointInShape(r,{x:s.x??0,y:s.y??0},{margin:0,hitInside:!0})){e=r.id;break}}let r=s.parentId;if(e===s.id&&(e=i),e!==r&&((s={...s}).parentId=e,(0,n.vc)(e))){let t=this.getPointInShapeSpace(this.getShape(e),{x:s.x??0,y:s.y??0});s.x=t.x,s.y=t.y,s.rotation=-this.getShapePageTransform(e).rotation()+(s.rotation??0)}}return s}),r=new Map,h=[],{opacityForNextShape:o}=this.getInstanceState();for(let e of s){let t=this.getShapeUtil(e),s=e.index;if(!s){let t=e.parentId??i;r.has(t)||r.set(t,this.getHighestIndexForParent(t)),s=r.get(t),r.set(t,(0,a.AQ)(s))}let n=t.getDefaultProps();for(let[t,i]of this.styleProps[e.type])n[i]=this.getStyleForNextShape(t);let p=this.store.schema.types.shape.create({...e,index:s,opacity:e.opacity??o,parentId:e.parentId??i,props:"props"in e?{...n,...e.props}:n});if(void 0===p.index)throw Error("no index!");let l=this.getShapeUtil(p).onBeforeCreate?.(p);l&&(p=l),h.push(p)}h.forEach(e=>{e.meta={...this.getInitialMetaForShape(e),...e.meta}}),this.store.put(h)}),this}animatingShapes=new Map;animateShape(e,t={animation:c.mp}){return this.animateShapes([e],t)}animateShapes(e,t={animation:c.mp}){let i,s,r;if(!t.animation)return this;let{duration:n=500,easing:h=I.Z.linear}=t.animation,o=(0,k.N)(),p=n,l=[];for(let t=0,i=e.length;t<i;t++){if(!(s=e[t]))continue;let i=this.getShape(s.id);i&&(r={start:(0,a.pN)(i),end:Q((0,a.pN)(i),s)},l.push(r),this.animatingShapes.set(i.id,o))}let g=t=>{if((p-=t)<0){let{animatingShapes:t}=this,i=e.filter(e=>e&&t.get(e.id)===o);i.length&&this.updateShapes(i),this.off("tick",g);return}i=h(1-p/n);let{animatingShapes:s}=this,r=[];for(let e=0,t=l.length;e<t;e++){let{start:t,end:n}=l[e];s.get(t.id)===o&&r.push({...n,x:t.x+(n.x-t.x)*i,y:t.y+(n.y-t.y)*i,opacity:t.opacity+(n.opacity-t.opacity)*i,rotation:t.rotation+(n.rotation-t.rotation)*i,props:this.getShapeUtil(n).getInterpolatedProps?.(t,n,i)??n.props})}this._updateShapes(r)};return this.on("tick",g),this}groupShapes(e,t={}){let{groupId:i=(0,n.n6)(),select:s=!0}=t;if(!Array.isArray(e))throw Error("Editor.groupShapes: must provide an array of shapes or shape ids");if(this.getInstanceState().isReadonly)return this;let r="string"==typeof e[0]?e:e.map(e=>e.id);if(r.length<=1)return this;let h=(0,a.oE)((this._shouldIgnoreShapeLock?r:this._getUnlockedShapeIds(r)).map(e=>this.getShape(e))),o=h.sort(a.Ky).map(e=>e.id),{x:p,y:l}=f.az.Common((0,a.oE)(h.map(e=>this.getShapePageBounds(e)))).point,g=this.findCommonAncestor(h)??this.getCurrentPageId();if("select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let d=h.filter(e=>e.parentId===g).sort(a.Ky),u=d[d.length-1]?.index;return this.run(()=>{this.createShapes([{id:i,type:"group",parentId:g,index:u,x:p,y:l,opacity:1,props:{}}]),this.reparentShapes(o,i),s&&this.select(i)}),this}ungroupShapes(e,t={}){if(this.getInstanceState().isReadonly)return this;let{select:i=!0}=t,s="string"==typeof e[0]?e:e.map(e=>e.id),r=(0,a.oE)((this._shouldIgnoreShapeLock?s:this._getUnlockedShapeIds(s)).map(e=>this.getShape(e)));if(0===r.length||"select"!==this.getCurrentToolId())return this;this.isIn("select.idle")||this.cancel();let n=new Set,h=[];return r.forEach(e=>{this.isShapeOfType(e,"group")?h.push(e):n.add(e.id)}),0===h.length||this.run(()=>{let e;for(let t=0,i=h.length;t<i;t++){e=h[t];let i=this.getSortedChildIdsForParent(e.id);for(let e=0,t=i.length;e<t;e++)n.add(i[e]);this.reparentShapes(i,e.parentId,e.index)}this.deleteShapes(h.map(e=>e.id)),i&&this.select(...n)}),this}updateShape(e){return this.updateShapes([e]),this}updateShapes(e){let t=Array(e.length);for(let i=0,s=e.length;i<s;i++){let s=e[i];if(!s)continue;let r=this.getShape(s.id);if(r){if(!this._shouldIgnoreShapeLock){if(r.isLocked){if(!(Object.hasOwn(s,"isLocked")&&!s.isLocked))continue}else if(this.isShapeOrAncestorLocked(r))continue}this.animatingShapes.delete(s.id),t.push(s)}}return this._updateShapes(t),this}_updateShapes=e=>{this.getInstanceState().isReadonly||this.run(()=>{let t,i;let s=[];for(let r=0,n=e.length;r<n;r++){let n=e[r];n&&(t=this.getShape(n.id))&&(i=Q(t,n))!==t&&(i=this.getShapeUtil(t).onBeforeUpdate?.(t,i)??i,s.push(i))}this.store.put(s)})};_getUnlockedShapeIds(e){return e.filter(e=>!this.getShape(e)?.isLocked)}deleteShapes(e){if(this.getInstanceState().isReadonly)return this;if(!Array.isArray(e))throw Error("Editor.deleteShapes: must provide an array of shapes or shapeIds");let t="string"==typeof e[0]?e:e.map(e=>e.id),i=this._shouldIgnoreShapeLock?t:this._getUnlockedShapeIds(t);if(0===i.length)return this;let s=new Set(i);for(let e of i)this.visitDescendants(e,e=>{s.add(e)});return this.run(()=>this.store.remove([...s]))}deleteShape(e){return this.deleteShapes(["string"==typeof e?e:e.id]),this}_extractSharedStyles(e,t){if(this.isShapeOfType(e,"group")){let i=this._parentIdsToChildIds.get()[e.id];if(i)for(let e=0,s=i.length;e<s;e++)this._extractSharedStyles(this.getShape(i[e]),t)}else for(let[i,s]of this.styleProps[e.type])t.applyValue(i,(0,a.g5)(e.props,s))}_getSelectionSharedStyles(){let e=this.getSelectedShapes(),t=new _.b;for(let i of e)this._extractSharedStyles(i,t);return t}getStyleForNextShape(e){let t=this.getInstanceState().stylesForNextShape[e.id];return void 0===t?e.defaultValue:t}getShapeStyleIfExists(e,t){let i=this.styleProps[e.type].get(t);if(void 0!==i)return(0,a.g5)(e.props,i)}getSharedStyles(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0)return this._getSelectionSharedStyles();let e=this.root.getCurrent(),t=new _.b;if(!e)return t;if(e.shapeType)for(let i of this.styleProps[e.shapeType].keys())t.applyValue(i,this.getStyleForNextShape(i));return t}getSharedOpacity(){if(this.isIn("select")&&this.getSelectedShapeIds().length>0){let e=[],t=i=>{let s=this.getShape(i);if(s){if(this.isShapeOfType(s,"group"))for(let e of this.getSortedChildIdsForParent(s.id))t(e);else e.push(s)}};for(let e of this.getSelectedShapeIds())t(e);let i=null;for(let t of e)if(null===i)i=t.opacity;else if(i!==t.opacity)return{type:"mixed"};if(null!==i)return{type:"shared",value:i}}return{type:"shared",value:this.getInstanceState().opacityForNextShape}}setOpacityForNextShapes(e,t){return this.updateInstanceState({opacityForNextShape:e},t),this}setOpacityForSelectedShapes(e){let t=this.getSelectedShapes();if(t.length>0){let i=[],s=e=>{if(this.isShapeOfType(e,"group"))for(let t of this.getSortedChildIdsForParent(e))s(this.getShape(t));else i.push(e)};for(let e of t)s(e);this.updateShapes(i.map(t=>({id:t.id,type:t.type,opacity:e})))}return this}setStyleForNextShapes(e,t,i){let s=this.getInstanceState().stylesForNextShape;return this.updateInstanceState({stylesForNextShape:{...s,[e.id]:t}},i),this}setStyleForSelectedShapes(e,t){let i=this.getSelectedShapes();if(i.length>0){let s=[],r=i=>{if(this.isShapeOfType(i,"group"))for(let e of this.getSortedChildIdsForParent(i.id))r(this.getShape(e));else{let r=this.getShapeUtil(i),n=this.styleProps[i.type].get(e);if(n){let e={id:i.id,type:i.type,props:{[n]:t}};s.push({util:r,originalShape:i,updatePartial:e})}}};for(let e of i)r(e);this.updateShapes(s.map(({updatePartial:e})=>e))}return this}externalAssetContentHandlers={file:null,url:null};registerExternalAssetHandler(e,t){return this.externalAssetContentHandlers[e]=t,this}async getAssetForExternalContent(e){return await this.externalAssetContentHandlers[e.type]?.(e)}hasExternalAssetHandler(e){return!!this.externalAssetContentHandlers[e]}externalContentHandlers={text:null,files:null,embed:null,"svg-text":null,url:null};registerExternalContentHandler(e,t){return this.externalContentHandlers[e]=t,this}async putExternalContent(e){return this.externalContentHandlers[e.type]?.(e)}getContentFromCurrentPage(e){let t="string"==typeof e[0]?e:e.map(e=>e.id);if(!t||0===t.length)return;let i=this.getShapeAndDescendantIds(t);return $(this,i,e=>{let t=[];for(let i of e){let e=this.getBinding(i);e&&t.push(e)}let s=[],r=[];for(let e of i){let t=this.getShape(e);if(t){if(i.has(t.parentId))r.push(t);else{let e=this.getShapePageTransform(t.id),i=e.point();r.push({...t,x:i.x,y:i.y,rotation:e.rotation(),parentId:this.getCurrentPageId()}),s.push(t.id)}}}let n=[],a=new Set;for(let e of r){if(!("assetId"in e.props))continue;let t=e.props.assetId;if(!t||a.has(t))continue;a.add(t);let i=this.getAsset(t);i&&n.push(i)}return{schema:this.store.schema.serialize(),shapes:r,rootShapeIds:s,bindings:t,assets:n}})}async resolveAssetsInContent(e){if(!e)return;let t=[];return await Promise.allSettled(e.assets.map(async e=>{if("image"!==e.type&&"video"!==e.type||e.props.src?.startsWith("data:image")||e.props.src?.startsWith("http"))t.push(e);else{let i=(0,a.pN)(e),s=await this.store.props.assets.resolve(e,{screenScale:1,steppedScreenScale:1,dpr:1,networkEffectiveType:null,shouldResolveToOriginal:!0});i.props.src=await a.Sm.blobToDataUrl(await (0,a.hd)(s).then(e=>e.blob())),t.push(i)}})),e.assets=t,e}putContentOntoCurrentPage(e,t={}){if(this.getInstanceState().isReadonly)return this;if(!e.schema)throw Error("Could not put content:\ncontent is missing a schema.");let{select:i=!1,preserveIds:s=!1,preservePosition:r=!1}=t,{point:h}=t,o=this.getCurrentPageId(),{rootShapeIds:p}=e,l=[],g=[],d=[],u={store:{...Object.fromEntries(e.assets.map(e=>[e.id,e])),...Object.fromEntries(e.shapes.map(e=>[e.id,e])),...Object.fromEntries(e.bindings?.map(e=>[e.id,e])??[])},schema:e.schema},c=this.store.schema.migrateStoreSnapshot(u);if("error"===c.type)throw Error("Could not put content: could not migrate content");for(let e of Object.values(c.value))switch(e.typeName){case"asset":l.push(e);break;case"shape":g.push(e);break;case"binding":d.push(e)}let S=new Map(s?g.map(e=>[e.id,e.id]):g.map(e=>[e.id,(0,n.n6)()])),I=new Map(s?d.map(e=>[e.id,e.id]):d.map(e=>[e.id,(0,n.BN)()])),P=this.getCurrentPageId(),C=1/0,w=[];for(let e of this.getSelectedShapes()){if(0===C)break;let t=this.isShapeOfType(e,"frame"),i=this.getShapeAncestors(e);t&&i.push(e);let s=t?i.length+1:i.length;if(s<C)C=s,w=i,P=t?e.id:e.parentId;else if(s===C){if(w.length!==i.length)throw Error(`Ancestors: ${w.length} !== ${i.length}`);if(0===w.length){P=o;break}P=o;for(let e=0;e<w.length&&i[e]===w[e];e++)P=i[e].id}}let _=!1;if(!(0,n.xh)(P)){let e=this.getShape(P);if(e){if(this.getViewportPageBounds().includes(this.getShapePageBounds(e))){if(1===p.length){let t=g.find(e=>e.id===p[0]);this.isShapeOfType(e,"frame")&&this.isShapeOfType(t,"frame")&&t.props.w===e?.props.w&&t.props.h===e?.props.h&&(_=!0)}}else P=o}else P=o}_||(_=S.has(P)),_&&(P=this.getShape(P).parentId);let T=this.getHighestIndexForParent(P),b=[],E=g.map(e=>{let t=S.get(e.id),i={...e,id:t};return p.includes(e.id)&&(i.parentId=o,b.push(i)),S.has(i.parentId)?i.parentId=S.get(e.parentId):(p.push(i.id),i.index=T,T=(0,a.AQ)(T)),i});if(E.length+this.getCurrentPageShapeIds().size>this.options.maxShapesPerPage)return j(this),this;let v=d.map(e=>({...e,id:(0,a.Z1)(I.get(e.id)),fromId:(0,a.Z1)(S.get(e.fromId)),toId:(0,a.Z1)(S.get(e.toId))})),k=[],B=[];for(let e of l)this.store.has(e.id)||(("image"===e.type||"video"===e.type)&&e.props.src?.startsWith("data:image")&&(B.push((0,a.pN)(e)),e.props.src=null),k.push(e));return Promise.allSettled(B.map(async e=>{let t=await (0,x.b)(e.props.src,e.props.name,e.props.mimeType??"image/png"),i=await this.getAssetForExternalContent({type:"file",file:t});if(!i){this.deleteAssets([e.id]);return}this.updateAssets([{...i,id:e.id}])})),this.run(()=>{k.length>0&&this.createAssets(k),this.createShapes(E),this.createBindings(v),i&&this.select(...b.map(e=>e.id)),P!==o&&this.reparentShapes(b.map(e=>e.id),P);let e=E.map(e=>this.getShape(e.id)),t=f.az.Common(e.map(e=>this.getShapePageBounds(e)));if(void 0===h){if((0,n.xh)(P)){let e=this.getViewportPageBounds();h=r||e.includes(f.az.From(t))?t.center:e.center}else{let e=this.getShape(P);h=m.V.applyToPoint(this.getShapePageTransform(e),this.getShapeGeometry(e).bounds.center)}}if(1===b.length){let e=b[0];if(this.isShapeOfType(e,"frame"))for(;this.getShapesAtPoint(h).some(t=>this.isShapeOfType(t,"frame")&&t.props.w===e.props.w&&t.props.h===e.props.h);)h.x+=t.w+16}let s=f.az.Common((0,a.oE)(b.map(({id:e})=>this.getShapePageBounds(e)))).center,p=y.l.Sub(h,s);this.updateShapes(b.map(({id:e})=>{let t=this.getShape(e),i=this.getShapeParentTransform(e).decompose().rotation,s=y.l.Rot(p,-i);return{id:t.id,type:t.type,x:t.x+s.x,y:t.y+s.y}}))}),this}async getSvgElement(e,t={}){let i=await (0,O.q)(this,e,t);if(!i)return;let s=document.createDocumentFragment(),r=(0,p.createRoot)(s);(0,o.flushSync)(()=>{r.render(i.jsx)});let n=s.firstElementChild;return(0,a.vA)(n instanceof SVGSVGElement,"Expected an SVG element"),r.unmount(),{svg:n,width:i.width,height:i.height}}async getSvgString(e,t={}){let i=await this.getSvgElement(e,t);if(i)return{svg:new XMLSerializer().serializeToString(i.svg),width:i.width,height:i.height}}async getSvg(e,t={}){let i=await this.getSvgElement(e,t);if(i)return i.svg}inputs={originPagePoint:new y.l,originScreenPoint:new y.l,previousPagePoint:new y.l,previousScreenPoint:new y.l,currentPagePoint:new y.l,currentScreenPoint:new y.l,keys:new Set,buttons:new Set,isPen:!1,shiftKey:!1,ctrlKey:!1,altKey:!1,isDragging:!1,isPointing:!1,isPinching:!1,isEditing:!1,isPanning:!1,pointerVelocity:new y.l};_updateInputsFromEvent(e){let{pointerVelocity:t,previousScreenPoint:i,previousPagePoint:r,currentScreenPoint:a,currentPagePoint:h}=this.inputs,{screenBounds:o}=this.store.unsafeGetWithoutCapture(n.O9),{x:p,y:l,z:g}=(0,s.Pm)(()=>this.getCamera()),d=e.point.x-o.x,u=e.point.y-o.y,S=e.point.z??.5;i.setTo(a),r.setTo(h),a.set(d,u);let f=d/g-p,m=u/g-l;isFinite(f)&&isFinite(m)&&h.set(f,m,S),this.inputs.isPen="pointer"===e.type&&e.isPen,("pointer_down"===e.name||this.inputs.isPinching)&&(t.set(0,0),this.inputs.originScreenPoint.setTo(a),this.inputs.originPagePoint.setTo(h)),this.run(()=>{this.store.put([{id:n.G1,typeName:"pointer",x:h.x,y:h.y,lastActivityTimestamp:"pointer"===e.type&&e.pointerId===c.zm.CAMERA_MOVE?this.store.unsafeGetWithoutCapture(n.G1)?.lastActivityTimestamp??this._tickManager.now:this._tickManager.now,meta:{}}])},{history:"ignore"})}cancel(){return this.dispatch({type:"misc",name:"cancel"}),this}interrupt(){return this.dispatch({type:"misc",name:"interrupt"}),this}complete(){return this.dispatch({type:"misc",name:"complete"}),this}focus({focusContainer:e=!0}={}){return this.getIsFocused()||(e&&this.focusManager.focus(),this.updateInstanceState({isFocused:!0})),this}blur({blurContainer:e=!0}={}){return this.getIsFocused()&&(e?this.focusManager.blur():this.complete(),this.updateInstanceState({isFocused:!1})),this}getIsFocused(){return this.getInstanceState().isFocused}getSnapshot(){return(0,l.d)(this.store)}loadSnapshot(e){return(0,l.N)(this.store,e),this}_clickManager=new U.s(this);cancelDoubleClick(){this._clickManager.cancelDoubleClickTimeout()}_prevCursor="default";_shiftKeyTimeout=-1;_setShiftKeyTimeout=()=>{this.inputs.shiftKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Shift",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ShiftLeft"})};_altKeyTimeout=-1;_setAltKeyTimeout=()=>{this.inputs.altKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Alt",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"AltLeft"})};_ctrlKeyTimeout=-1;_setCtrlKeyTimeout=()=>{this.inputs.ctrlKey=!1,this.dispatch({type:"keyboard",name:"key_up",key:"Ctrl",shiftKey:this.inputs.shiftKey,ctrlKey:this.inputs.ctrlKey,altKey:this.inputs.altKey,code:"ControlLeft"})};_restoreToolId="select";_pinchStart=1;_didPinch=!1;_selectedShapeIdsAtPointerDown=[];_longPressTimeout=-1;capturedPointerId=null;performanceTracker;performanceTrackerTimeout=-1;dispatch=e=>(this._pendingEventsForNextTick.push(e),"pointer"===e.type&&"pointer_move"===e.name||"wheel"===e.type||"pinch"===e.type||this._flushEventsForTick(0),this);_pendingEventsForNextTick=[];_flushEventsForTick(e){this.run(()=>{if(this._pendingEventsForNextTick.length>0){let e=[...this._pendingEventsForNextTick];for(let t of(this._pendingEventsForNextTick.length=0,e))this._flushEventForTick(t)}e>0&&this.root.handleEvent({type:"misc",name:"tick",elapsed:e}),this.scribbles.tick(e)})}_flushEventForTick=e=>{if(this.getCrashingError())return this;let{inputs:t}=this,{type:i}=e;if("misc"===e.type){("cancel"===e.name||"complete"===e.name)&&(this.inputs.isDragging=!1,this.inputs.isPanning&&(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor,rotation:0}))),this.root.handleEvent(e);return}e.shiftKey?(clearTimeout(this._shiftKeyTimeout),this._shiftKeyTimeout=-1,t.shiftKey=!0):!e.shiftKey&&t.shiftKey&&-1===this._shiftKeyTimeout&&(this._shiftKeyTimeout=this.timers.setTimeout(this._setShiftKeyTimeout,150)),e.altKey?(clearTimeout(this._altKeyTimeout),this._altKeyTimeout=-1,t.altKey=!0):!e.altKey&&t.altKey&&-1===this._altKeyTimeout&&(this._altKeyTimeout=this.timers.setTimeout(this._setAltKeyTimeout,150)),e.ctrlKey?(clearTimeout(this._ctrlKeyTimeout),this._ctrlKeyTimeout=-1,t.ctrlKey=!0):!e.ctrlKey&&t.ctrlKey&&-1===this._ctrlKeyTimeout&&(this._ctrlKeyTimeout=this.timers.setTimeout(this._setCtrlKeyTimeout,150));let{originPagePoint:r,currentPagePoint:a}=t;t.isPointing||(t.isDragging=!1);let h=this.store.unsafeGetWithoutCapture(n.O9),o=this.store.get(this._getCurrentPageStateId()),p=this._cameraOptions.__unsafe__getWithoutCapture();switch(i){case"pinch":if(p.isLocked)return;switch(clearTimeout(this._longPressTimeout),this._updateInputsFromEvent(e),e.name){case"pinch_start":if(t.isPinching)return;t.isEditing||(this._pinchStart=this.getCamera().z,this._selectedShapeIdsAtPointerDown.length||(this._selectedShapeIdsAtPointerDown=[...o.selectedShapeIds]),this._didPinch=!0,t.isPinching=!0,this.interrupt());return;case"pinch":{if(!t.isPinching)return;let{point:{z:i=1},delta:{x:r,y:n}}=e,{x:a,y:o}=y.l.SubXY(e.point,h.screenBounds.x,h.screenBounds.y);this.stopCameraAnimation(),h.followingUserId&&this.stopFollowingUser();let{x:l,y:g,z:d}=(0,s.Pm)(()=>this.getCamera()),{panSpeed:u,zoomSpeed:c}=p;this._setCamera(new y.l(l+r*u/d-a/d+a/(i*c),g+n*u/d-o/d+o/(i*c),i*c),{immediate:!0});return}case"pinch_end":{if(!t.isPinching)return this;t.isPinching=!1;let{_selectedShapeIdsAtPointerDown:e}=this;this.setSelectedShapes(this._selectedShapeIdsAtPointerDown),this._selectedShapeIdsAtPointerDown=[],this._didPinch&&(this._didPinch=!1,e.length>0&&this.once("tick",()=>{this._didPinch||this.setSelectedShapes(e)}));return}}case"wheel":if(p.isLocked)return;if(this._updateInputsFromEvent(e),this.getIsMenuOpen());else{let{panSpeed:i,zoomSpeed:r,wheelBehavior:n}=p;if("none"!==n){this.stopCameraAnimation(),h.followingUserId&&this.stopFollowingUser();let{x:a,y:o,z:p}=(0,s.Pm)(()=>this.getCamera()),{x:l,y:g,z:d=0}=e.delta,u=n;switch(t.ctrlKey&&(u="pan"===n?"zoom":"pan"),u){case"zoom":{let{x:e,y:t}=this.inputs.currentScreenPoint,i=d;"zoom"===n&&(i=Math.abs(g)>10?10*Math.sign(g)/100:g/100);let s=p+(i??0)*r*p;this._setCamera(new y.l(a+(e/s-e)-(e/p-e),o+(t/s-t)-(t/p-t),s),{immediate:!0}),this.maybeTrackPerformance("Zooming");return}case"pan":this._setCamera(new y.l(a+l*i/p,o+g*i/p,p),{immediate:!0}),this.maybeTrackPerformance("Panning");return}}}break;case"pointer":{if(t.isPinching)return;this._updateInputsFromEvent(e);let{isPen:i}=e,{isPenMode:n}=h;switch(e.name){case"pointer_down":if(n&&!i)return;if(this.clearOpenMenus(),this.inputs.isPanning||(this._longPressTimeout=this.timers.setTimeout(()=>{this.dispatch({...e,point:this.inputs.currentScreenPoint,name:"long_press"})},this.options.longPressDurationMs)),this._selectedShapeIdsAtPointerDown=this.getSelectedShapeIds(),e.button===c.bH&&(this.capturedPointerId=e.pointerId),t.buttons.add(e.button),t.isPointing=!0,t.isDragging=!1,!n&&i&&this.updateInstanceState({isPenMode:!0}),e.button===c.Tf?(this._restoreToolId=this.getCurrentToolId(),this.complete(),this.setCurrentTool("eraser")):e.button===c.R_&&(this.inputs.isPanning||(this._prevCursor=this.getInstanceState().cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout)),this.inputs.isPanning)return this.stopCameraAnimation(),this.setCursor({type:"grabbing",rotation:0}),this;break;case"pointer_move":{if(!i&&n)return;let{x:e,y:o,z:l}=(0,s.Pm)(()=>this.getCamera());if(this.inputs.isPanning&&this.inputs.isPointing){let{currentScreenPoint:t,previousScreenPoint:i}=this.inputs,{panSpeed:s}=p,r=y.l.Sub(t,i);this.setCamera(new y.l(e+r.x*s/l,o+r.y*s/l,l),{immediate:!0}),this.maybeTrackPerformance("Panning");return}t.isPointing&&!t.isDragging&&y.l.Dist2(r,a)*this.getZoomLevel()>(h.isCoarsePointer?this.options.coarseDragDistanceSquared:this.options.dragDistanceSquared)/l&&(t.isDragging=!0,clearTimeout(this._longPressTimeout));break}case"pointer_up":if(t.isDragging=!1,t.isPointing=!1,clearTimeout(this._longPressTimeout),t.buttons.delete(e.button),this.getIsMenuOpen()||h.isPenMode&&!i)return;if(this.capturedPointerId===e.pointerId&&(this.capturedPointerId=null,e.button=0),t.isPanning){t.keys.has("Space")||(t.isPanning=!1);let i=this.inputs.pointerVelocity,s=Math.min(2,i.len());switch(e.button){case c.bH:this.setCursor({type:"grab",rotation:0});break;case c.R_:this.inputs.keys.has(" ")?this.setCursor({type:"grab",rotation:0}):this.setCursor({type:this._prevCursor,rotation:0})}s>0&&this.slideCamera({speed:s,direction:i})}else e.button===c.Tf&&(this.complete(),this.setCurrentTool(this._restoreToolId))}break}case"keyboard":switch("ShiftRight"===e.key&&(e.key="ShiftLeft"),"AltRight"===e.key&&(e.key="AltLeft"),"ControlRight"===e.code&&(e.code="ControlLeft"),e.name){case"key_down":t.keys.add(e.code),"Space"!==e.code||e.ctrlKey||(this.inputs.isPanning||(this._prevCursor=h.cursor.type),this.inputs.isPanning=!0,clearTimeout(this._longPressTimeout),this.setCursor({type:this.inputs.isPointing?"grabbing":"grab",rotation:0}));break;case"key_up":t.keys.delete(e.code),"Space"===e.code&&(this.inputs.buttons.has(c.R_)||(this.inputs.isPanning=!1,this.setCursor({type:this._prevCursor,rotation:0})))}}if("pointer"===e.type){e.button===c.R_?e.name="middle_click":e.button===c.EI&&(e.name="right_click");let{isPenMode:t}=this.store.unsafeGetWithoutCapture(n.O9);if(e.isPen===t){let t=this._clickManager.handlePointerEvent(e);if(e.name!==t.name){this.root.handleEvent(e),this.emit("event",e),this.root.handleEvent(t),this.emit("event",t);return}}}return this.root.handleEvent(e),this.emit("event",e),this};maybeTrackPerformance(e){T.bG.measurePerformance.get()&&(this.performanceTracker.isStarted()?clearTimeout(this.performanceTrackerTimeout):this.performanceTracker.start(e),this.performanceTrackerTimeout=this.timers.setTimeout(()=>{this.performanceTracker.stop()},50))}}function j(e,t=e.getCurrentPageId()){let i=e.getPage(t).name;e.emit("max-shapes",{name:i,pageId:t,count:e.options.maxShapesPerPage})}function Q(e,t){if(!t)return e;let i=null,s=Object.entries(t);for(let t=0,r=s.length;t<r;t++){let[r,n]=s[t];if(void 0!==n&&"id"!==r&&"type"!==r&&"typeName"!==r&&n!==e[r]){if(i||(i={...e}),"props"===r||"meta"===r){for(let[t,s]of(i[r]={...e[r]},Object.entries(n)))void 0!==s&&(i[r][t]=s);continue}i[r]=n}}return i||e}function $(e,t,i){let s;if(e.run(()=>{let n=e.store.extractingChanges(()=>{let r=new Set,n=new Set;for(let i of t)if(e.getShape(i))for(let s of e.getBindingsInvolvingShape(i)){let e=t.has(s.fromId),i=t.has(s.toId);if(e&&i){r.add(s.id);continue}e&&i||n.add(s.id)}e.deleteBindings([...n],{isolateShapes:!0});try{s=a.Q7.ok(i(r))}catch(e){s=a.Q7.err(e)}});e.store.applyDiff((0,r.E8)(n))},{history:"ignore"}),s.ok)return s.value;throw s.error}function J(e,t){if(!t.constraints)throw Error("Should have constraints here");let{padding:{x:i,y:s}}=t.constraints,r=e.getViewportScreenBounds(),n=f.az.From(t.constraints.bounds);return{zx:(r.w-2*i)/n.w,zy:(r.h-2*s)/n.h}}Z([s.EW],q.prototype,"getCanUndo",1),Z([s.EW],q.prototype,"getCanRedo",1),Z([s.EW],q.prototype,"getPath",1),Z([s.EW],q.prototype,"getCurrentTool",1),Z([s.EW],q.prototype,"getCurrentToolId",1),Z([s.EW],q.prototype,"getDocumentSettings",1),Z([s.EW],q.prototype,"getInstanceState",1),Z([s.EW],q.prototype,"getOpenMenus",1),Z([s.EW],q.prototype,"getIsMenuOpen",1),Z([s.EW],q.prototype,"getPageStates",1),Z([s.EW],q.prototype,"_getPageStatesQuery",1),Z([s.EW],q.prototype,"getCurrentPageState",1),Z([s.EW],q.prototype,"_getCurrentPageStateId",1),Z([s.EW],q.prototype,"getSelectedShapeIds",1),Z([s.EW],q.prototype,"getSelectedShapes",1),Z([s.EW],q.prototype,"getOnlySelectedShapeId",1),Z([s.EW],q.prototype,"getOnlySelectedShape",1),Z([s.EW],q.prototype,"getSelectionPageBounds",1),Z([s.EW],q.prototype,"getSelectionRotation",1),Z([s.EW],q.prototype,"getSelectionRotatedPageBounds",1),Z([s.EW],q.prototype,"getSelectionRotatedScreenBounds",1),Z([s.EW],q.prototype,"getFocusedGroupId",1),Z([s.EW],q.prototype,"getFocusedGroup",1),Z([s.EW],q.prototype,"getEditingShapeId",1),Z([s.EW],q.prototype,"getEditingShape",1),Z([s.EW],q.prototype,"getHoveredShapeId",1),Z([s.EW],q.prototype,"getHoveredShape",1),Z([s.EW],q.prototype,"getHintingShapeIds",1),Z([s.EW],q.prototype,"getHintingShape",1),Z([s.EW],q.prototype,"getErasingShapeIds",1),Z([s.EW],q.prototype,"getErasingShapes",1),Z([s.EW],q.prototype,"_unsafe_getCameraId",1),Z([s.EW],q.prototype,"getCamera",1),Z([s.EW],q.prototype,"getViewportPageBoundsForFollowing",1),Z([s.EW],q.prototype,"getCameraForFollowing",1),Z([s.EW],q.prototype,"getZoomLevel",1),Z([s.EW],q.prototype,"getViewportScreenBounds",1),Z([s.EW],q.prototype,"getViewportScreenCenter",1),Z([s.EW],q.prototype,"getViewportPageBounds",1),Z([s.EW],q.prototype,"_getCollaboratorsQuery",1),Z([s.EW],q.prototype,"getCollaborators",1),Z([s.EW],q.prototype,"getCollaboratorsOnCurrentPage",1),Z([s.EW],q.prototype,"getRenderingShapes",1),Z([s.EW],q.prototype,"_getAllPagesQuery",1),Z([s.EW],q.prototype,"getPages",1),Z([s.EW],q.prototype,"getCurrentPageId",1),Z([s.EW],q.prototype,"getCurrentPageShapeIdsSorted",1),Z([s.EW],q.prototype,"_getAllAssetsQuery",1),Z([s.EW],q.prototype,"_getShapeGeometryCache",1),Z([s.EW],q.prototype,"_getShapeHandlesCache",1),Z([s.EW],q.prototype,"_getShapePageTransformCache",1),Z([s.EW],q.prototype,"_getShapePageBoundsCache",1),Z([s.EW],q.prototype,"_getShapeClipPathCache",1),Z([s.EW],q.prototype,"_getShapeMaskCache",1),Z([s.EW],q.prototype,"_getShapeMaskedPageBoundsCache",1),Z([s.EW],q.prototype,"_notVisibleShapes",1),Z([s.EW],q.prototype,"getCulledShapes",1),Z([s.EW],q.prototype,"getCurrentPageBounds",1),Z([s.EW],q.prototype,"getCurrentPageShapes",1),Z([s.EW],q.prototype,"getCurrentPageShapesSorted",1),Z([s.EW],q.prototype,"getCurrentPageRenderingShapesSorted",1),Z([s.EW],q.prototype,"_getBindingsIndexCache",1),Z([s.EW],q.prototype,"_getSelectionSharedStyles",1),Z([(0,s.EW)({isEqual:(e,t)=>e.equals(t)})],q.prototype,"getSharedStyles",1),Z([s.EW],q.prototype,"getSharedOpacity",1),Z([s.EW],q.prototype,"getIsFocused",1)}}]);